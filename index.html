<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Chat App</title>
    <!-- Use a modern, easy-to-read font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-color: #6366F1;
            --primary-light: #C7D2FE;
            --background-color: #F8FAFC;
            --chat-bg-dark: #E2E8F0;
            --chat-bg-light: #E0E7FF;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
        }

        /* Hide scrollbar for a cleaner look */
        .chat-container::-webkit-scrollbar {
            display: none;
        }

        .chat-container {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 md:p-8">

    <!-- Main application container -->
    <div class="w-full max-w-2xl bg-white rounded-3xl shadow-2xl overflow-hidden flex flex-col h-[80vh]">

        <!-- Header -->
        <header class="bg-indigo-600 text-white p-4 md:p-5 flex justify-between items-center shadow-lg">
            <h1 class="text-xl md:text-2xl font-bold">Collaborative Chat</h1>
            <div id="user-display-container" class="flex items-center space-x-2">
                <div id="user-info" class="text-sm"></div>
                <button id="sign-out-button" class="bg-red-500 text-white p-2 rounded-full shadow-lg hover:bg-red-600 transition-all duration-300 transform active:scale-95 text-xs">Sign Out</button>
            </div>
        </header>

        <!-- Authentication Form Container -->
        <div id="auth-container" class="flex-grow flex flex-col items-center justify-center p-8 space-y-4">
            <h2 class="text-2xl font-bold text-gray-700">Sign Up or Log In</h2>
            <form id="email-auth-form" class="w-full max-w-sm space-y-4">
                <input type="email" id="email-input" placeholder="Email" required
                       class="w-full p-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-gray-800">
                <input type="password" id="password-input" placeholder="Password" required
                       class="w-full p-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-gray-800">
                <div class="flex space-x-2">
                    <button type="button" id="sign-up-button"
                            class="flex-grow bg-green-500 text-white p-3 rounded-full shadow-lg hover:bg-green-600 transition-all duration-300 transform active:scale-95 font-bold">
                        Sign Up
                    </button>
                    <button type="button" id="sign-in-button"
                            class="flex-grow bg-indigo-600 text-white p-3 rounded-full shadow-lg hover:bg-indigo-700 transition-all duration-300 transform active:scale-95 font-bold">
                        Sign In
                    </button>
                </div>
            </form>
            <div class="relative w-full max-w-sm flex items-center justify-center my-4">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="bg-white px-2 text-gray-500">OR</span>
                </div>
            </div>
            <button id="google-sign-in-button"
                    class="w-full max-w-sm flex items-center justify-center space-x-2 p-3 rounded-full bg-blue-500 text-white shadow-lg hover:bg-blue-600 transition-all duration-300 transform active:scale-95 font-bold">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22.56 12.24c0-.78-.07-1.5-.19-2.22h-10.22v4.19h5.81c-.26 1.34-1.07 2.47-2.25 3.23l.01.01 3.51 2.72.25.01c2.1-1.92 3.32-4.71 3.32-8.21z" />
                    <path d="M12.24 22.56c2.81 0 5.17-.91 6.89-2.48l-3.51-2.72c-.99.71-2.27 1.13-3.38 1.13-2.61 0-4.83-1.76-5.63-4.13H3.08l-.01.01-3.6 2.8c1.69 3.3 5.25 5.52 9.47 5.52z" />
                    <path d="M6.61 14.15c-.21-.63-.33-1.3-.33-2.02s.12-1.4.33-2.02V8.04H3.08c-.76 1.54-1.19 3.3-1.19 5.24s.43 3.7 1.19 5.24l3.53-2.75z" />
                    <path d="M12.24 6.57c1.47 0 2.74.5 3.78 1.48l3.14-3.14c-1.89-1.74-4.32-2.82-7.14-2.82-4.22 0-7.78 2.22-9.47 5.52l3.6 2.8c.8-2.37 3.02-4.13 5.63-4.13z" />
                </svg>
                <span>Sign in with Google</span>
            </button>
        </div>

        <!-- Chat UI Container -->
        <div id="chat-ui" class="flex-grow flex flex-col hidden">
            <!-- Chat messages container -->
            <main id="chat-messages" class="flex-grow p-4 overflow-y-auto chat-container space-y-4">
                <!-- Messages will be dynamically inserted here -->
                <div id="loading-indicator" class="text-center text-gray-500 mt-10">
                    <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-2">Loading chat history...</p>
                </div>
            </main>
    
            <!-- Message input area -->
            <footer class="p-4 md:p-5 bg-gray-50 border-t border-gray-200">
                <div class="flex flex-col space-y-3">
                    <!-- Gemini API buttons -->
                    <div class="flex flex-wrap gap-2 justify-center">
                        <button id="summarize-button"
                                class="bg-purple-500 text-white p-2 rounded-full shadow-lg hover:bg-purple-600 transition-all duration-300 transform active:scale-95 text-sm flex items-center justify-center">
                            <span class="mr-1">âœ¨</span>Summarize Chat
                        </button>
                        <button id="tts-button"
                                class="bg-blue-500 text-white p-2 rounded-full shadow-lg hover:bg-blue-600 transition-all duration-300 transform active:scale-95 text-sm flex items-center justify-center">
                            <span class="mr-1">ðŸ”Š</span>Read Latest Message
                        </button>
                    </div>
                    <div class="flex space-x-3">
                        <input type="text" id="message-input" placeholder="Type a message..."
                               class="flex-grow p-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-gray-800">
                        <button id="send-button"
                                class="bg-indigo-600 text-white p-3 rounded-full shadow-lg hover:bg-indigo-700 transition-all duration-300 transform active:scale-95">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                            </svg>
                        </button>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Hidden audio element for TTS playback -->
    <audio id="tts-audio" style="display: none;"></audio>
    <!-- Message Modal/Pop-up -->
    <div id="modal-container" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold mb-4">Error</h3>
            <p id="modal-text" class="text-gray-700 mb-6"></p>
            <button id="modal-ok-button" class="w-full bg-indigo-600 text-white p-3 rounded-full hover:bg-indigo-700 transition-all">OK</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, limit, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase services
        let app, db, auth;
        let userId, username;
        let allMessages = [];

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyB7F1uRRiGdw489c_18aJeodbxrzsdFb5c",
            authDomain: "exonova-cd89c.firebaseapp.com",
            databaseURL: "https://exonova-cd89c-default-rtdb.firebaseio.com",
            projectId: "exonova-cd89c",
            storageBucket: "exonova-cd89c.firebasestorage.app",
            messagingSenderId: "465326262278",
            appId: "1:465326262278:web:1b7f8f62e1f46c5ca7db87",
            measurementId: "G-GGG45V0PEF"
        };
        const appId = firebaseConfig.appId.split(':')[1].split('/')[0];

        // --- Helper functions for TTS audio conversion ---
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }
        
        function pcmToWav(pcmData, sampleRate) {
            const pcm16 = pcmData;
            const channelCount = 1;
            const bytesPerSample = 2;
            const blockAlign = channelCount * bytesPerSample;
        
            const buffer = new ArrayBuffer(44 + pcm16.length * bytesPerSample);
            const view = new DataView(buffer);
        
            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.length * bytesPerSample, true);
            writeString(view, 8, 'WAVE');
        
            // FMT sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // Linear PCM
            view.setUint16(22, channelCount, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * blockAlign, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bytesPerSample * 8, true);
        
            // DATA sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.length * bytesPerSample, true);
        
            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += bytesPerSample) {
                view.setInt16(offset, pcm16[i], true);
            }
        
            return new Blob([view], { type: 'audio/wav' });
        
            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }
        }
        
        /**
         * Converts a Firestore Timestamp object to a formatted date string.
         * @param {Object} timestamp - The Firestore Timestamp object.
         * @returns {string} The formatted date and time string.
         */
        function formatTimestamp(timestamp) {
            if (!timestamp || !timestamp.seconds) return 'Sending...';
            const date = new Date(timestamp.seconds * 1000);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            let dateString;
            if (date.toDateString() === today.toDateString()) {
                dateString = 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                dateString = 'Yesterday';
            } else {
                dateString = date.toLocaleDateString();
            }

            const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            return `${dateString}, ${timeString}`;
        }

        /**
         * Renders a single message to the UI.
         * @param {Object} message - The message data object.
         * @param {string} message.text - The message text.
         * @param {string} message.userId - The ID of the user who sent the message.
         * @param {string} message.username - The username of the user who sent the message (NEW).
         * @param {Object} message.timestamp - The Firestore Timestamp object.
         * @param {boolean} isCurrentUser - True if the message was sent by the current user.
         */
        function renderMessage(message, isCurrentUser) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-[70%] md:max-w-[60%] p-3 rounded-xl shadow-md transition-all duration-200 ease-in-out transform` +
                ` ${isCurrentUser ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-bl-none'}`;

            const messageText = document.createElement('p');
            messageText.className = 'break-words text-sm md:text-base';
            messageText.textContent = message.text;

            const messageMeta = document.createElement('div');
            messageMeta.className = `text-xs mt-1 text-right italic ${isCurrentUser ? 'text-indigo-200' : 'text-gray-500'}`;
            
            const senderName = message.username || 'Unknown';
            const senderIdSpan = document.createElement('span');
            senderIdSpan.className = 'font-bold break-all opacity-80';
            senderIdSpan.textContent = isCurrentUser ? 'You' : senderName;

            const timestampSpan = document.createElement('span');
            timestampSpan.textContent = ` â€¢ ${formatTimestamp(message.timestamp)}`;

            messageMeta.appendChild(senderIdSpan);
            messageMeta.appendChild(timestampSpan);
            
            messageBubble.appendChild(messageText);
            messageBubble.appendChild(messageMeta);
            messageElement.appendChild(messageBubble);

            messagesContainer.appendChild(messageElement);
        }

        /**
         * Clears all messages from the chat container.
         */
        function clearMessages() {
            const messagesContainer = document.getElementById('chat-messages');
            while (messagesContainer.firstChild) {
                messagesContainer.removeChild(messagesContainer.firstChild);
            }
        }

        /**
         * Displays a modal message box for errors or alerts.
         * @param {string} text - The message to display.
         */
        function showModal(text) {
            const modalContainer = document.getElementById('modal-container');
            const modalText = document.getElementById('modal-text');
            modalText.textContent = text;
            modalContainer.classList.remove('hidden');
        }
        
        /**
         * Sends a new message to the Firestore database.
         */
        async function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const messageText = messageInput.value.trim();

            if (messageText === '') {
                return;
            }

            if (!userId) {
                showModal("You must be signed in to send messages.");
                return;
            }
            
            try {
                const chatCollection = collection(db, `/artifacts/${appId}/users/${userId}/chat_messages`);
                await addDoc(chatCollection, {
                    text: messageText,
                    userId: userId,
                    username: username,
                    timestamp: serverTimestamp()
                });
                
                messageInput.value = '';
                messageInput.focus();

            } catch (e) {
                console.error("Error adding document: ", e);
                showModal("Error sending message. Please try again.");
            }
        }

        /**
         * Calls the Gemini LLM to summarize the last messages.
         */
        async function summarizeChat() {
            if (allMessages.length === 0) {
                showModal("No messages to summarize.");
                return;
            }

            showModal("Summarizing chat... Please wait.");
            
            const chatHistoryText = allMessages.map(m => `${m.username || 'User'}: ${m.text}`).join('\n');
            const prompt = `Summarize the following chat conversation into a single, concise paragraph:\n\n${chatHistoryText}`;

            try {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                };

                let response, result;
                let delay = 1000;
                for (let i = 0; i < 5; i++) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.status !== 429) {
                            result = await response.json();
                            break;
                        }
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    } catch (e) {
                        throw e;
                    }
                }
                
                if (result && result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const summary = result.candidates[0].content.parts[0].text;
                    showModal(`Chat Summary:\n\n${summary}`);
                } else {
                    showModal("Could not generate a summary. Please try again later.");
                }

            } catch (e) {
                console.error("Error calling Gemini API for summarization:", e);
                showModal("An error occurred while summarizing the chat.");
            }
        }

        /**
         * Calls the Gemini TTS API to read the latest message aloud.
         */
        async function readLatestMessage() {
            if (allMessages.length === 0) {
                showModal("No messages to read.");
                return;
            }

            const latestMessage = allMessages[allMessages.length - 1].text;
            showModal("Generating audio... Please wait.");
            const ttsAudio = document.getElementById('tts-audio');

            const payload = {
                contents: [{
                    parts: [{ text: latestMessage }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    ttsAudio.src = audioUrl;
                    ttsAudio.play();
                    showModal("Playing audio message!");
                } else {
                    showModal("Could not generate audio. The message might be too long or the API returned an unexpected format.");
                }

            } catch (e) {
                console.error("Error calling Gemini API for TTS:", e);
                showModal("An error occurred while generating audio.");
            }
        }

        // --- Authentication Functions ---
        async function signUp() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showModal(`Sign Up Failed: ${error.message}`);
            }
        }

        async function signIn() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showModal(`Sign In Failed: ${error.message}`);
            }
        }

        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                showModal(`Google Sign In Failed: ${error.message}`);
            }
        }

        async function userSignOut() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign out error:", error);
                showModal("An error occurred during sign out.");
            }
        }

        /**
         * Initializes Firebase and sets up the real-time listener.
         */
        async function initFirebase() {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in. Show chat UI.
                    userId = user.uid;
                    username = user.displayName || user.email;

                    document.getElementById('user-info').textContent = `Signed in as: ${username}`;
                    document.getElementById('auth-container').classList.add('hidden');
                    document.getElementById('chat-ui').classList.remove('hidden');

                    const chatCollectionRef = collection(db, `/artifacts/${appId}/users/${userId}/chat_messages`);
                    
                    onSnapshot(chatCollectionRef, (querySnapshot) => {
                        const messages = [];
                        querySnapshot.forEach((doc) => {
                            messages.push(doc.data());
                        });

                        messages.sort((a, b) => {
                            if (a.timestamp && b.timestamp) {
                                return a.timestamp.seconds - b.timestamp.seconds;
                            }
                            return a.timestamp ? -1 : 1; 
                        });

                        allMessages = messages;
                        clearMessages();
                        document.getElementById('loading-indicator').style.display = 'none';

                        allMessages.forEach(msg => {
                            renderMessage(msg, msg.userId === userId);
                        });

                        const messagesContainer = document.getElementById('chat-messages');
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;

                    }, (error) => {
                        console.error("Error listening for messages: ", error);
                        showModal("Error loading chat messages. Please refresh the page.");
                    });
                } else {
                    // User is signed out. Show auth UI.
                    userId = null;
                    username = null;
                    clearMessages();
                    document.getElementById('user-info').textContent = '';
                    document.getElementById('auth-container').classList.remove('hidden');
                    document.getElementById('chat-ui').classList.add('hidden');
                }
            });
        }
        
        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', initFirebase);
        document.getElementById('send-button').addEventListener('click', sendMessage);
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Authentication buttons
        document.getElementById('sign-up-button').addEventListener('click', signUp);
        document.getElementById('sign-in-button').addEventListener('click', signIn);
        document.getElementById('google-sign-in-button').addEventListener('click', signInWithGoogle);
        document.getElementById('sign-out-button').addEventListener('click', userSignOut);

        // API Buttons
        document.getElementById('summarize-button').addEventListener('click', summarizeChat);
        document.getElementById('tts-button').addEventListener('click', readLatestMessage);

        // Modal close button
        document.getElementById('modal-ok-button').addEventListener('click', () => {
            document.getElementById('modal-container').classList.add('hidden');
        });

    </script>
</body>
</html>
