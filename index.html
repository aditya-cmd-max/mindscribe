import React, { useState, useEffect } from 'react';

// Import all required Firebase modules
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signInAnonymously, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch } from 'firebase/firestore';
import { Transition } from '@headlessui/react';
import { CheckIcon, ClipboardIcon, TrashIcon, SparklesIcon, Bars3Icon, XMarkIcon, PlusCircleIcon, ChevronDownIcon, DocumentPlusIcon, FolderPlusIcon, ArrowRightEndOnRectangleIcon } from '@heroicons/react/24/solid';

// The main application component
export default function App() {
  // --- State Management ---
  const [user, setUser] = useState(null);
  const [userId, setUserId] = useState(null);
  const [notebooks, setNotebooks] = useState([]);
  const [notes, setNotes] = useState([]);
  const [selectedNotebookId, setSelectedNotebookId] = useState(null);
  const [selectedNoteId, setSelectedNoteId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [isLogin, setIsLogin] = useState(true);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [message, setMessage] = useState('');
  const [showNotebookForm, setShowNotebookForm] = useState(false);
  const [newNotebookName, setNewNotebookName] = useState('');
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  const [aiPrompt, setAiPrompt] = useState('');
  const [aiResponse, setAiResponse] = useState('Ask AI a question or request a summary here...');
  const [isAiLoading, setIsAiLoading] = useState(false);

  // --- Firebase Setup ---
  const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  // Initializing Firebase and getting services
  const firebaseApp = initializeApp(firebaseConfig);
  const auth = getAuth(firebaseApp);
  const db = getFirestore(firebaseApp);

  // --- Effects and Event Listeners ---
  // Effect for handling initial authentication state and sign-in
  useEffect(() => {
    // This listener ensures the app's state is always in sync with Firebase Auth
    const unsubscribeAuth = onAuthStateChanged(auth, async (currentUser) => {
      setUser(currentUser);
      if (currentUser) {
        setUserId(currentUser.uid);
      } else {
        setUserId(null);
      }
      setIsAuthReady(true);
      setIsLoading(false);
    });

    // Sign-in with the custom token provided by the canvas environment
    const handleSignIn = async () => {
      if (initialAuthToken) {
        try {
          await signInWithCustomToken(auth, initialAuthToken);
        } catch (error) {
          console.error("Error signing in with custom token:", error);
          // Fallback to anonymous sign-in if token fails or is not provided
          await signInAnonymously(auth);
        }
      } else {
        await signInAnonymously(auth);
      }
    };
    handleSignIn();

    // Clean up the auth listener when the component unmounts
    return () => unsubscribeAuth();
  }, [auth, initialAuthToken]);

  // Effect for setting up Firestore listeners for notes and notebooks
  useEffect(() => {
    // Listeners are only active if the user is authenticated and the auth state is ready
    if (!userId || !isAuthReady) return;

    // Listener for notebooks
    const notebooksRef = collection(db, 'artifacts', appId, 'users', userId, 'notebooks');
    const unsubscribeNotebooks = onSnapshot(notebooksRef, (snapshot) => {
      const fetchedNotebooks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setNotebooks(fetchedNotebooks);

      // If no notebook is selected or the selected one was deleted, select the first one
      if (fetchedNotebooks.length > 0 && (!selectedNotebookId || !fetchedNotebooks.some(nb => nb.id === selectedNotebookId))) {
        setSelectedNotebookId(fetchedNotebooks[0].id);
      } else if (fetchedNotebooks.length === 0) {
        setSelectedNotebookId(null);
      }
    });

    // Clean up the notebook listener
    return () => unsubscribeNotebooks();
  }, [userId, isAuthReady, db, appId, selectedNotebookId]);

  // Effect for notes, dependent on selectedNotebookId
  useEffect(() => {
    if (!userId || !selectedNotebookId) {
      setNotes([]);
      setSelectedNoteId(null);
      return;
    }

    // Listener for notes, filtered by the selected notebook ID
    const notesRef = collection(db, 'artifacts', appId, 'users', userId, 'notes');
    const q = query(notesRef, where('notebookId', '==', selectedNotebookId));
    const unsubscribeNotes = onSnapshot(q, (snapshot) => {
      const fetchedNotes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // Sort notes by last updated time
      fetchedNotes.sort((a, b) => (b.updatedAt?.toDate()?.getTime() || 0) - (a.updatedAt?.toDate()?.getTime() || 0));
      setNotes(fetchedNotes);

      // If no note is selected or the selected one was deleted, select the first one
      if (fetchedNotes.length > 0 && (!selectedNoteId || !fetchedNotes.some(n => n.id === selectedNoteId))) {
        setSelectedNoteId(fetchedNotes[0].id);
      } else if (fetchedNotes.length === 0) {
        setSelectedNoteId(null);
      }
    });

    // Clean up the notes listener
    return () => unsubscribeNotes();
  }, [userId, db, appId, selectedNotebookId, selectedNoteId]);


  // --- Helper Functions ---
  const showMessage = (msg, isError = false) => {
    setMessage(msg);
    setTimeout(() => setMessage(''), 5000);
  };

  const handleAuth = async () => {
    try {
      if (isLogin) {
        await signInWithEmailAndPassword(auth, email, password);
      } else {
        await createUserWithEmailAndPassword(auth, email, password);
      }
    } catch (error) {
      showMessage(error.message, true);
    }
  };

  const handleGoogleAuth = async () => {
    const provider = new GoogleAuthProvider();
    try {
      await signInWithPopup(auth, provider);
    } catch (error) {
      showMessage(error.message, true);
    }
  };

  const handleLogout = () => {
    signOut(auth);
  };

  const createNotebook = async () => {
    if (!newNotebookName.trim()) {
      showMessage("Notebook name cannot be empty.", true);
      return;
    }
    try {
      const notebooksRef = collection(db, 'artifacts', appId, 'users', userId, 'notebooks');
      await addDoc(notebooksRef, { name: newNotebookName, createdAt: new Date() });
      setNewNotebookName('');
      setShowNotebookForm(false);
    } catch (e) {
      console.error("Error creating notebook: ", e);
      showMessage("Failed to create notebook.", true);
    }
  };

  const deleteNotebook = async (notebookId) => {
    const isConfirmed = window.confirm("Are you sure you want to delete this notebook and all its notes?");
    if (!isConfirmed) return;
    try {
      const batch = writeBatch(db);
      const notesRef = collection(db, 'artifacts', appId, 'users', userId, 'notes');
      const q = query(notesRef, where('notebookId', '==', notebookId));
      const querySnapshot = await getDocs(q);
      querySnapshot.docs.forEach(noteDoc => {
        batch.delete(doc(notesRef, noteDoc.id));
      });
      batch.delete(doc(db, 'artifacts', appId, 'users', userId, 'notebooks', notebookId));
      await batch.commit();
    } catch (e) {
      console.error("Error deleting notebook: ", e);
      showMessage("Failed to delete notebook.", true);
    }
  };

  const createNote = async () => {
    if (!selectedNotebookId) {
      showMessage("Please select or create a notebook first.", true);
      return;
    }
    try {
      const notesRef = collection(db, 'artifacts', appId, 'users', userId, 'notes');
      const newDoc = await addDoc(notesRef, {
        title: 'New Note',
        content: '',
        notebookId: selectedNotebookId,
        createdAt: new Date(),
        updatedAt: new Date()
      });
      setSelectedNoteId(newDoc.id);
    } catch (e) {
      console.error("Error creating note: ", e);
      showMessage("Failed to create note.", true);
    }
  };

  const updateNote = async (id, updatedFields) => {
    try {
      const noteRef = doc(db, 'artifacts', appId, 'users', userId, 'notes', id);
      await updateDoc(noteRef, { ...updatedFields, updatedAt: new Date() });
    } catch (e) {
      console.error("Error updating note: ", e);
      showMessage("Failed to update note.", true);
    }
  };

  const deleteNote = async (id) => {
    const isConfirmed = window.confirm("Are you sure you want to delete this note?");
    if (!isConfirmed) return;
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'notes', id));
    } catch (e) {
      console.error("Error deleting note: ", e);
      showMessage("Failed to delete note.", true);
    }
  };

  const handleExport = () => {
    const note = notes.find(n => n.id === selectedNoteId);
    if (!note) return;
    const markdownContent = `# ${note.title}\n\n${note.content}`;
    const tempTextArea = document.createElement('textarea');
    tempTextArea.value = markdownContent;
    document.body.appendChild(tempTextArea);
    tempTextArea.select();
    document.execCommand('copy');
    document.body.removeChild(tempTextArea);
    showMessage("Note content copied to clipboard!");
  };

  const handleAiRequest = async () => {
    if (!aiPrompt.trim()) return;
    setIsAiLoading(true);
    setAiResponse('Thinking...');

    const note = notes.find(n => n.id === selectedNoteId);
    const promptWithContext = note
      ? `Based on the following note content: "${note.content}", please answer this request: ${aiPrompt}`
      : aiPrompt;

    const chatHistory = [{ role: "user", parts: [{ text: promptWithContext }] }];
    const payload = { contents: chatHistory };
    const apiKey = ""
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

    let resultText = "Failed to get a response from the AI. Please try again.";
    let retries = 0;
    const maxRetries = 3;
    const initialDelay = 1000;

    while (retries < maxRetries) {
      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const result = await response.json();
        if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
          resultText = result.candidates[0].content.parts[0].text;
          break; // Success, exit the retry loop
        } else {
          throw new Error("Unexpected response structure from the API.");
        }
      } catch (error) {
        console.error(`Attempt ${retries + 1} failed:`, error);
        retries++;
        if (retries < maxRetries) {
          const delay = initialDelay * Math.pow(2, retries - 1);
          await new Promise(res => setTimeout(res, delay));
        }
      }
    }

    setAiResponse(resultText);
    setIsAiLoading(false);
    setAiPrompt('');
  };


  // --- Component Rendering ---
  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-950 text-gray-400 font-inter">
        <svg className="animate-spin h-12 w-12 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
          <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <h2 className="text-xl font-semibold ml-4">Loading Mindscribe...</h2>
      </div>
    );
  }

  // --- Auth Form ---
  if (!user) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-950 font-inter text-gray-100 p-4">
        <div className="bg-gray-900 p-8 rounded-2xl shadow-2xl w-full max-w-sm border border-gray-800 animate-fade-in">
          <h2 className="text-4xl font-extrabold text-center mb-6 text-indigo-500">Mindscribe</h2>
          <div className="space-y-4">
            <input
              type="email"
              placeholder="Email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="w-full p-3 rounded-lg bg-gray-800 text-white placeholder-gray-500 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200"
            />
            <input
              type="password"
              placeholder="Password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="w-full p-3 rounded-lg bg-gray-800 text-white placeholder-gray-500 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200"
            />
            <button
              onClick={handleAuth}
              className="w-full p-3 rounded-lg font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-lg transform active:scale-95"
            >
              {isLogin ? 'Login' : 'Sign Up'}
            </button>
            <button
              onClick={handleGoogleAuth}
              className="w-full p-3 rounded-lg font-bold text-gray-300 border border-gray-700 hover:bg-gray-800 transition-colors duration-200 flex items-center justify-center space-x-2"
            >
              <svg className="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.61 20.25h-2.11v-.01h-.06c-.11-.74-.23-1.5-.38-2.23s-.31-1.46-.46-2.18l-1.12-5.75H41.5z"/><path fill="#0277BD" d="M43.61 20.25H24.5v3.21h11.23c-1.16 3.86-4.57 6.44-9.74 6.44-5.83 0-10.74-4.59-10.74-10.23s4.91-10.23 10.74-10.23c3.27 0 6.09 1.45 8.1 3.59l2.76-2.71c-3.13-2.9-7.23-4.66-10.86-4.66-10.02 0-18.17 8.05-18.17 18s8.15 18 18.17 18c9.22 0 16.5-6.83 18.12-16.14l-.06-.32z"/><path fill="#0277BD" d="M12.44 24c0-2.31.57-4.49 1.58-6.44L10.3 14.8C8.94 17.52 8.21 20.67 8.21 24c0 3.33.73 6.48 2.09 9.2l3.72-2.76c-1.01-1.95-1.58-4.13-1.58-6.44z"/><path fill="#FFC107" d="M24.5 44c5.07 0 9.77-1.89 13.3-5.06l-4.22-3.32c-2.32 2.01-5.26 3.18-9.08 3.18-6.72 0-12.28-5.32-12.28-12.04h-4.33C4.16 35.95 12.92 44 24.5 44z"/><path fill="#1565C0" d="M43.61 20.25H24.5v3.21h11.23c-1.16 3.86-4.57 6.44-9.74 6.44-5.83 0-10.74-4.59-10.74-10.23s4.91-10.23 10.74-10.23c3.27 0 6.09 1.45 8.1 3.59l2.76-2.71c-3.13-2.9-7.23-4.66-10.86-4.66-10.02 0-18.17 8.05-18.17 18s8.15 18 18.17 18c9.22 0 16.5-6.83 18.12-16.14l-.06-.32z"/><path fill="#388E3C" d="M24.5 3.75c3.22 0 6.13 1.25 8.35 3.28l3.75-3.66C32.96 1.48 28.9 0 24.5 0 13 0 4.25 8.05 4.25 18h4.33c0-6.72 5.56-12.04 12.28-12.04z"/></svg>
              Sign In with Google
            </button>
          </div>
          <p
            onClick={() => setIsLogin(!isLogin)}
            className="text-center mt-4 text-gray-500 text-sm cursor-pointer hover:underline transition-colors duration-200"
          >
            {isLogin ? "Don't have an account? Sign Up" : "Already have an account? Login"}
          </p>
          <Transition
            show={!!message}
            enter="transition-opacity duration-300"
            enterFrom="opacity-0"
            enterTo="opacity-100"
            leave="transition-opacity duration-300"
            leaveFrom="opacity-100"
            leaveTo="opacity-0"
            className="mt-4 p-3 rounded-lg text-sm text-white bg-red-600 text-center shadow-lg"
          >
            {message}
          </Transition>
        </div>
      </div>
    );
  }

  // --- Main Dashboard ---
  const selectedNote = notes.find(n => n.id === selectedNoteId);

  return (
    <div className="flex flex-col lg:flex-row min-h-screen bg-gray-950 text-gray-100 font-inter">
      {/* Sidebar - Mobile Toggle */}
      <div className="lg:hidden p-4 bg-gray-900 border-b border-gray-800 flex items-center justify-between">
        <h1 className="text-2xl font-extrabold text-indigo-500">Mindscribe</h1>
        <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 rounded-lg text-white hover:bg-gray-800 transition-colors">
          {isSidebarOpen ? <XMarkIcon className="h-6 w-6" /> : <Bars3Icon className="h-6 w-6" />}
        </button>
      </div>

      {/* Sidebar - Desktop and Mobile */}
      <Transition
        show={isSidebarOpen || window.innerWidth >= 1024}
        as="aside"
        enter="transition-transform duration-300 ease-out"
        enterFrom="-translate-x-full lg:translate-x-0"
        enterTo="translate-x-0"
        leave="transition-transform duration-300 ease-in"
        leaveFrom="translate-x-0"
        leaveTo="-translate-x-full"
        className="fixed inset-y-0 left-0 z-50 w-80 bg-gray-900 shadow-xl border-r border-gray-800 lg:static lg:flex lg:flex-col p-6 animate-slide-in"
      >
        <h1 className="hidden lg:block text-3xl font-extrabold mb-6 text-indigo-500">Mindscribe</h1>
        <div className="flex flex-col items-center mb-6 p-4 rounded-xl bg-gray-800 shadow-inner">
          <span className="text-sm text-gray-400 font-medium">User ID:</span>
          <span className="text-xs truncate font-mono text-gray-300 mt-1">{userId}</span>
          <button
            onClick={handleLogout}
            className="w-full px-4 py-2 mt-3 rounded-lg text-sm font-semibold bg-red-600 hover:bg-red-700 transition-colors duration-200 text-white shadow-md transform active:scale-95"
          >
            <ArrowRightEndOnRectangleIcon className="h-4 w-4 inline-block mr-2" /> Logout
          </button>
        </div>

        {/* New Notebook Section */}
        <div className="mb-6">
          <button
            onClick={() => setShowNotebookForm(!showNotebookForm)}
            className="w-full p-3 rounded-lg font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md flex items-center justify-center transform active:scale-95"
          >
            <FolderPlusIcon className="h-5 w-5 mr-2" /> New Notebook
          </button>
          <Transition
            show={showNotebookForm}
            enter="transition-all duration-300 ease-out"
            enterFrom="opacity-0 max-h-0"
            enterTo="opacity-100 max-h-24"
            leave="transition-all duration-300 ease-in"
            leaveFrom="opacity-100 max-h-24"
            leaveTo="opacity-0 max-h-0"
            className="overflow-hidden"
          >
            <form onSubmit={(e) => { e.preventDefault(); createNotebook(); }} className="mt-3 flex">
              <input
                type="text"
                value={newNotebookName}
                onChange={(e) => setNewNotebookName(e.target.value)}
                placeholder="Notebook name"
                className="flex-grow p-3 rounded-l-lg bg-gray-800 text-white placeholder-gray-500 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              />
              <button
                type="submit"
                className="p-3 rounded-r-lg bg-indigo-600 hover:bg-indigo-700 text-white font-bold transition-colors shadow-md transform active:scale-95"
              >
                <PlusCircleIcon className="h-5 w-5" />
              </button>
            </form>
          </Transition>
        </div>

        {/* Notebook List */}
        <nav className="flex-grow overflow-y-auto pr-2 mb-6 space-y-2">
          <h2 className="text-xl font-bold mb-3 text-white flex items-center">
            Notebooks
            <ChevronDownIcon className="h-5 w-5 ml-2 transform rotate-0" />
          </h2>
          <ul className="space-y-2">
            {notebooks.length > 0 ? (
              notebooks.map(notebook => (
                <li
                  key={notebook.id}
                  onClick={() => {
                    setSelectedNotebookId(notebook.id);
                    setIsSidebarOpen(false); // Close sidebar on mobile
                  }}
                  className={`flex items-center justify-between p-3 rounded-xl cursor-pointer transition-all duration-200 shadow-md ${
                    selectedNotebookId === notebook.id ? 'bg-indigo-600 text-white' : 'bg-gray-800 hover:bg-gray-700'
                  }`}
                >
                  <span className="font-medium truncate">{notebook.name}</span>
                  <button onClick={(e) => { e.stopPropagation(); deleteNotebook(notebook.id); }} className="text-gray-400 hover:text-red-500 transition-colors text-lg font-bold">
                    <TrashIcon className="h-5 w-5" />
                  </button>
                </li>
              ))
            ) : (
              <p className="text-gray-500 text-sm text-center">No notebooks. Create one!</p>
            )}
          </ul>
        </nav>

        {/* New Note Button */}
        <div className="mt-auto">
          <button
            onClick={createNote}
            className="w-full p-3 rounded-lg font-bold text-white bg-green-600 hover:bg-green-700 transition-colors duration-200 shadow-md flex items-center justify-center transform active:scale-95"
          >
            <DocumentPlusIcon className="h-5 w-5 mr-2" /> New Note
          </button>
        </div>
      </Transition>

      {/* Main Content Area */}
      <main className="flex-grow p-6 grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in">
        {/* Notes List Panel */}
        <div className="lg:col-span-1 p-6 rounded-2xl bg-gray-900 shadow-2xl border border-gray-800 flex flex-col h-full overflow-y-auto">
          <h2 className="text-2xl font-bold mb-4 text-white">Notes</h2>
          <ul className="space-y-2 flex-grow overflow-y-auto pr-2">
            {notes.length > 0 ? (
              notes.map(note => (
                <li
                  key={note.id}
                  onClick={() => setSelectedNoteId(note.id)}
                  className={`p-4 rounded-xl cursor-pointer shadow-md transition-all duration-200 ${
                    selectedNoteId === note.id ? 'bg-indigo-600 text-white' : 'bg-gray-800 hover:bg-gray-700'
                  }`}
                >
                  <h3 className={`font-semibold text-lg ${selectedNoteId === note.id ? '' : 'text-white'}`}>{note.title || 'Untitled Note'}</h3>
                  <p className={`text-sm ${selectedNoteId === note.id ? 'text-gray-200' : 'text-gray-400'}`}>
                    {note.updatedAt ? new Date(note.updatedAt.toDate()).toLocaleString() : 'N/A'}
                  </p>
                </li>
              ))
            ) : (
              <p className="text-gray-500 text-center mt-4">No notes in this notebook. Create one!</p>
            )}
          </ul>
        </div>

        {/* Note Editor and AI Assistant Panels */}
        <div className="lg:col-span-2 flex flex-col h-full">
          {/* Note Editor */}
          <div className="p-6 rounded-2xl bg-gray-900 shadow-2xl border border-gray-800 flex-grow mb-6">
            {selectedNote ? (
              <div className="flex flex-col h-full">
                <input
                  type="text"
                  value={selectedNote.title}
                  onChange={(e) => updateNote(selectedNote.id, { title: e.target.value })}
                  placeholder="Note Title"
                  className="text-3xl font-bold w-full bg-transparent outline-none text-white placeholder-gray-500 mb-4"
                />
                <textarea
                  value={selectedNote.content}
                  onChange={(e) => updateNote(selectedNote.id, { content: e.target.value })}
                  placeholder="Start writing..."
                  className="flex-grow p-4 rounded-xl bg-gray-800 text-white resize-none outline-none focus:ring-2 focus:ring-indigo-500 w-full"
                />
                <div className="flex flex-wrap gap-4 mt-4">
                  <button
                    onClick={() => deleteNote(selectedNote.id)}
                    className="flex-1 px-6 py-3 rounded-lg text-white bg-red-600 hover:bg-red-700 transition-colors duration-200 font-bold shadow-md transform active:scale-95 flex items-center justify-center"
                  >
                    <TrashIcon className="h-5 w-5 mr-2" /> Delete
                  </button>
                  <button
                    onClick={handleExport}
                    className="flex-1 px-6 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-bold transition-colors duration-200 shadow-md transform active:scale-95 flex items-center justify-center"
                  >
                    <ClipboardIcon className="h-5 w-5 mr-2" /> Export
                  </button>
                </div>
              </div>
            ) : (
              <div className="flex items-center justify-center h-full text-center text-gray-500">
                <p className="text-xl font-medium">Select a note or create a new one.</p>
              </div>
            )}
          </div>

          {/* AI Assistant */}
          <div className="p-6 rounded-2xl bg-gray-900 shadow-2xl border border-gray-800 flex flex-col flex-grow">
            <h3 className="text-2xl font-bold mb-4 text-white flex items-center">
              <SparklesIcon className="h-6 w-6 mr-2 text-indigo-400" /> AI Assistant
            </h3>
            <div className="flex-grow overflow-y-auto mb-4 p-4 rounded-xl bg-gray-800 text-gray-400">
              <p className="whitespace-pre-wrap">{aiResponse}</p>
            </div>
            <div className="flex gap-4 mt-auto">
              <input
                type="text"
                value={aiPrompt}
                onChange={(e) => setAiPrompt(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleAiRequest()}
                placeholder="Ask AI a question..."
                className="flex-grow p-3 rounded-lg border border-gray-700 bg-gray-800 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              />
              <button
                onClick={handleAiRequest}
                disabled={isAiLoading}
                className={`px-6 py-3 rounded-lg font-bold text-white transition-colors duration-200 shadow-md transform active:scale-95 ${isAiLoading ? 'bg-gray-600 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700'}`}
              >
                {isAiLoading ? 'Sending...' : 'Send'}
              </button>
            </div>
          </div>
        </div>
      </main>
    </div>
  );
}
