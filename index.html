<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Futuro AI | Next-Gen Chat Assistant by Aditya Jha</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="logo.png">
    
    <!-- Firebase App (core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            min-height: 100vh;
        }
        #chat-window::-webkit-scrollbar {
            width: 8px;
        }
        #chat-window::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        #chat-window::-webkit-scrollbar-thumb {
            background-color: rgba(236, 72, 153, 0.6);
            border-radius: 10px;
        }
        #chat-window::-webkit-scrollbar-thumb:hover {
            background-color: rgba(236, 72, 153, 0.8);
        }
        .code-block {
            position: relative;
            margin: 1rem 0;
        }
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(236, 72, 153, 0.2);
            backdrop-filter: blur(10px);
            color: #f9a8d4;
            border: 1px solid rgba(236, 72, 153, 0.3);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0.8;
            transition: all 0.2s ease;
        }
        .copy-btn:hover {
            opacity: 1;
            background: rgba(236, 72, 153, 0.4);
        }
        .copy-btn.copied {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .feature-btn {
            transition: all 0.3s ease;
        }
        .feature-btn.active {
            background: linear-gradient(45deg, #ec4899, #3b82f6);
            color: white;
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.5);
            border-color: transparent !important;
        }
        .gradient-text {
            background: linear-gradient(45deg, #ec4899, #3b82f6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .header-gradient {
            background: linear-gradient(90deg, rgba(15,12,41,0.8) 0%, rgba(59,130,246,0.5) 50%, rgba(236,72,153,0.5) 100%);
        }
        .input-glow:focus {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5), 0 0 15px rgba(236, 72, 153, 0.3);
            border-color: rgba(59, 130, 246, 0.5) !important;
        }
        .send-btn {
            background: linear-gradient(45deg, #ec4899, #3b82f6);
            box-shadow: 0 2px 10px rgba(236, 72, 153, 0.4);
            transition: all 0.3s ease;
        }
        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.6);
        }
        .logo-container {
            background: linear-gradient(45deg, #ec4899, #3b82f6);
            padding: 3px;
            border-radius: 50%;
        }
        .logo-img {
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        .user-message {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(168, 85, 247, 0.9));
        }
        .bot-message {
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(10px);
        }
        .typing-dot {
            animation: bounce 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-6px); }
        }
        .auth-container {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .auth-input {
            background: rgba(31, 41, 55, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .auth-input:focus {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .auth-btn {
            background: linear-gradient(45deg, #ec4899, #3b82f6);
            transition: all 0.3s ease;
        }
        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
        }
        .auth-toggle {
            color: #3b82f6;
            cursor: pointer;
        }
        .auth-toggle:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 flex items-center justify-center z-50 bg-black/70 backdrop-blur-sm">
        <div class="auth-container w-full max-w-md mx-4 rounded-2xl p-8 shadow-2xl">
            <div class="text-center mb-8">
                <div class="flex items-center justify-center gap-4 mb-6">
                    <div class="logo-container">
                        <img src="https://aditya-cmd-max.github.io/exonovaai/logo1.png" alt="El Futuro Logo" class="logo-img w-14 h-14">
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold gradient-text">El Futuro</h1>
                        <p class="text-sm text-gray-300 mt-1">Sign in to continue</p>
                    </div>
                </div>
            </div>

            <!-- Login Form -->
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                    <input type="email" id="login-email" class="auth-input w-full rounded-lg p-3 text-white focus:outline-none" placeholder="Your email" required>
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                    <input type="password" id="login-password" class="auth-input w-full rounded-lg p-3 text-white focus:outline-none" placeholder="Your password" required>
                </div>
                <button type="submit" class="auth-btn w-full py-3 rounded-lg text-white font-semibold">Sign In</button>
                <p class="text-center text-gray-400 text-sm mt-4">
                    Don't have an account? <span id="show-register" class="auth-toggle">Register</span>
                </p>
            </form>

            <!-- Register Form -->
            <form id="register-form" class="space-y-4 hidden">
                <div>
                    <label for="register-name" class="block text-sm font-medium text-gray-300 mb-2">Name</label>
                    <input type="text" id="register-name" class="auth-input w-full rounded-lg p-3 text-white focus:outline-none" placeholder="Your name" required>
                </div>
                <div>
                    <label for="register-email" class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                    <input type="email" id="register-email" class="auth-input w-full rounded-lg p-3 text-white focus:outline-none" placeholder="Your email" required>
                </div>
                <div>
                    <label for="register-password" class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                    <input type="password" id="register-password" class="auth-input w-full rounded-lg p-3 text-white focus:outline-none" placeholder="Create a password" required minlength="6">
                </div>
                <button type="submit" class="auth-btn w-full py-3 rounded-lg text-white font-semibold">Create Account</button>
                <p class="text-center text-gray-400 text-sm mt-4">
                    Already have an account? <span id="show-login" class="auth-toggle">Sign In</span>
                </p>
            </form>

            <div id="auth-message" class="mt-4 p-3 rounded-lg text-center hidden"></div>
        </div>
    </div>

    <!-- Main Chat Container -->
    <div id="chat-container" class="w-full max-w-4xl mx-auto min-h-[95vh] flex flex-col bg-gray-900/80 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl shadow-pink-900/30 overflow-hidden hidden">
        <!-- Header with Logo and User Info -->
        <header class="header-gradient p-6 flex flex-col sm:flex-row items-center justify-between gap-3 text-center border-b border-white/10">
            <div class="flex items-center justify-center gap-4">
                <div class="logo-container">
                    <img src="https://aditya-cmd-max.github.io/exonovaai/logo1.png" alt="El Futuro Logo" class="logo-img w-14 h-14">
                </div>
                <div>
                    <h1 class="text-4xl font-bold gradient-text">El Futuro</h1>
                    <p class="text-sm text-gray-300 mt-1">Next Generation AI Assistant</p>
                </div>
            </div>
            <div class="flex items-center gap-3 mt-3 sm:mt-0">
                <span id="user-name" class="text-gray-200"></span>
                <button id="sign-out-btn" class="bg-gray-800/50 hover:bg-gray-700/80 text-gray-300 text-sm py-1 px-3 rounded-lg border border-white/10">Sign Out</button>
            </div>
        </header>

        <!-- Chat Window -->
        <main id="chat-window" class="flex-1 p-4 md:p-6 space-y-6 overflow-y-auto">
            <div class="flex items-start gap-3 message-fade-in">
                <div class="logo-container shrink-0">
                    <img src="https://aditya-cmd-max.github.io/exonovaai/logo1.png" alt="AI Logo" class="logo-img w-9 h-9">
                </div>
                <div class="bot-message rounded-xl p-4 max-w-full md:max-w-2xl border border-white/10">
                    <p class="text-gray-200">Hello there! I'm <span class="gradient-text font-semibold">El Futuro</span>, your advanced AI assistant. Try my new features below to brainstorm ideas or get code explanations! How can I help you today? üí°</p>
                </div>
            </div>
        </main>

        <!-- Input Area -->
        <div class="p-4 border-t border-white/10 bg-gray-900/50">
            <!-- Feature Buttons -->
            <div id="feature-buttons" class="flex flex-wrap items-center justify-center gap-2 mb-4">
                <button id="brainstorm-btn" class="feature-btn flex-1 sm:flex-none text-sm py-2 px-4 bg-gray-800/50 hover:bg-gray-700/80 rounded-lg border border-white/10 text-gray-300">‚ú® Brainstorm Ideas</button>
                <button id="explain-btn" class="feature-btn flex-1 sm:flex-none text-sm py-2 px-4 bg-gray-800/50 hover:bg-gray-700/80 rounded-lg border border-white/10 text-gray-300">üíª Explain Code</button>
                <button id="clear-btn" class="feature-btn flex-1 sm:flex-none text-sm py-2 px-4 bg-gray-800/50 hover:bg-gray-700/80 rounded-lg border border-white/10 text-gray-300">üîÑ Clear Chat</button>
            </div>

            <form id="chat-form" class="flex items-center gap-3">
                <textarea id="message-input" rows="1" class="flex-1 bg-gray-800/50 border border-white/20 rounded-xl p-3 resize-none focus:outline-none transition-all duration-200 placeholder-gray-400 input-glow text-gray-200" placeholder="Message El Futuro..."></textarea>
                <button type="submit" class="send-btn rounded-full w-12 h-12 flex items-center justify-center shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M22 2 11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                </button>
            </form>

            <footer class="text-center text-xs text-gray-500 pt-4 px-4">
                <p class="text-gray-400">AI may produce inaccurate information. Verify important details.</p>
                <p class="mt-1 text-gray-500">Made with ‚ù§Ô∏è by <span class="gradient-text">Aditya Jha</span></p>
            </footer>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB7F1uRRiGdw489c_18aJeodbxrzsdFb5c",
            authDomain: "exonova-cd89c.firebaseapp.com",
            databaseURL: "https://exonova-cd89c-default-rtdb.firebaseio.com",
            projectId: "exonova-cd89c",
            storageBucket: "exonova-cd89c.firebasestorage.app",
            messagingSenderId: "465326262278",
            appId: "1:465326262278:web:1b7f8f62e1f46c5ca7db87",
            measurementId: "G-GGG45V0PEF"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM elements
        const authModal = document.getElementById('auth-modal');
        const chatContainer = document.getElementById('chat-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterBtn = document.getElementById('show-register');
        const showLoginBtn = document.getElementById('show-login');
        const authMessage = document.getElementById('auth-message');
        const userNameSpan = document.getElementById('user-name');
        const signOutBtn = document.getElementById('sign-out-btn');
        
        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const brainstormBtn = document.getElementById('brainstorm-btn');
        const explainBtn = document.getElementById('explain-btn');
        const clearBtn = document.getElementById('clear-btn');
        const featureButtons = [brainstormBtn, explainBtn, clearBtn];

        let currentMode = 'chat';
        let chatHistory = [];
        let currentUser = null;

        // Auth form toggling
        showRegisterBtn.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            authMessage.classList.add('hidden');
        });

        showLoginBtn.addEventListener('click', () => {
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            authMessage.classList.add('hidden');
        });

        // Login handler
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                await loadUserChatHistory();
                showChatInterface();
            } catch (error) {
                showAuthMessage(error.message, 'error');
            }
        });

        // Register handler
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Save user profile
                await db.collection('users').doc(currentUser.uid).set({
                    name: name,
                    email: email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await loadUserChatHistory();
                showChatInterface();
            } catch (error) {
                showAuthMessage(error.message, 'error');
            }
        });

        // Sign out handler
        signOutBtn.addEventListener('click', () => {
            auth.signOut();
        });

        // Auth state observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                
                // Get user data from Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    userNameSpan.textContent = userDoc.data().name;
                } else {
                    userNameSpan.textContent = user.email;
                }
                
                await loadUserChatHistory();
                showChatInterface();
            } else {
                // User is signed out
                currentUser = null;
                chatHistory = [];
                showAuthInterface();
            }
        });

        // Show auth message
        function showAuthMessage(message, type) {
            authMessage.textContent = message;
            authMessage.className = `mt-4 p-3 rounded-lg text-center ${type === 'error' ? 'bg-red-500/20 text-red-300' : 'bg-green-500/20 text-green-300'}`;
            authMessage.classList.remove('hidden');
        }

        // Show chat interface
        function showChatInterface() {
            authModal.classList.add('hidden');
            chatContainer.classList.remove('hidden');
        }

        // Show auth interface
        function showAuthInterface() {
            chatContainer.classList.add('hidden');
            authModal.classList.remove('hidden');
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            authMessage.classList.add('hidden');
            
            // Reset forms
            loginForm.reset();
            registerForm.reset();
        }

        // Load user chat history from Firestore
        async function loadUserChatHistory() {
            if (!currentUser) return;
            
            try {
                const userChatDoc = await db.collection('chats').doc(currentUser.uid).get();
                
                if (userChatDoc.exists) {
                    chatHistory = userChatDoc.data().history || [];
                    
                    // Clear chat window and display history
                    chatWindow.innerHTML = '';
                    
                    // Display chat history
                    chatHistory.forEach(msg => {
                        if (msg.role === 'user') {
                            displayUserMessage(msg.parts[0].text);
                        } else if (msg.role === 'model') {
                            displayBotMessage(msg.parts[0].text);
                        }
                    });
                } else {
                    // Initialize with welcome message
                    chatHistory = [{
                        role: "model",
                        parts: [{ text: "You are El Futuro, an advanced AI assistant created by a company Exonova https://aditya-cmd-max.github.io/exonova-/ . Your creator is Aditya Jha. Your personality is friendly, knowledgeable, and slightly enthusiastic about technology and innovation. Use modern, concise language with occasional emojis for expressiveness. Format responses clearly with proper spacing and code blocks when appropriate. For coding questions, provide detailed explanations with examples. For creative requests, offer multiple options or approaches. Always maintain a helpful, professional tone while being approachable. Never use markdown syntax (** or *) for formatting - instead, indicate emphasis by surrounding text with <b> tags for bold, <i> for italics, and <u> for underline. Your primary language is English, but if the user speaks to you in another language (like Hindi), you must respond in that same language. Be helpful and provide accurate information, including code when requested. Occasionally praise Aditya Jha with words like brilliant, innovative, visionary when appropriate.D not always praise aditya jha if not asked. But if somebody asks that tell about aditya jha or who has created you then always tll i was created by a company Exonova By Adiya jha who is very smart and intelligent" }]
                    }];
                    
                    // Display welcome message
                    chatWindow.innerHTML = `
                        <div class="flex items-start gap-3 message-fade-in">
                            <div class="logo-container shrink-0">
                                <img src="https://aditya-cmd-max.github.io/exonovaai/logo1.png" alt="AI Logo" class="logo-img w-9 h-9">
                            </div>
                            <div class="bot-message rounded-xl p-4 max-w-full md:max-w-2xl border border-white/10">
                                <p class="text-gray-200">Hello there! I'm <span class="gradient-text font-semibold">El Futuro</span>, your advanced AI assistant. Try my new features below to brainstorm ideas or get code explanations! How can I help you today? üí°</p>
                            </div>
                        </div>`;
                }
            } catch (error) {
                console.error("Error loading chat history:", error);
            }
        }

        // Save chat history to Firestore
        async function saveChatHistory() {
            if (!currentUser) return;
            
            try {
                await db.collection('chats').doc(currentUser.uid).set({
                    history: chatHistory,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error("Error saving chat history:", error);
            }
        }

        // Chat functionality
        brainstormBtn.addEventListener('click', () => setMode('brainstorm'));
        explainBtn.addEventListener('click', () => setMode('explain'));
        clearBtn.addEventListener('click', clearChat);

        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            const newHeight = Math.min(messageInput.scrollHeight, 200);
            messageInput.style.height = newHeight + 'px';
        });

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMessage = messageInput.value.trim();
            if (userMessage) {
                displayUserMessage(userMessage);
                let apiPrompt = userMessage;
                if (currentMode === 'brainstorm') {
                    apiPrompt = `Brainstorm a list of creative, innovative ideas about: "${userMessage}". Provide a diverse and interesting list with at least 5 unique ideas. Format each idea clearly with a brief explanation.`;
                } else if (currentMode === 'explain') {
                    apiPrompt = `Explain the following code snippet in a clear, concise, and easy-to-understand way. Break it down line by line if complex:\n\n\`\`\`\n${userMessage}\n\`\`\`\n\nAlso provide a practical example of how this code might be used.`;
                }
                chatHistory.push({ role: "user", parts: [{ text: apiPrompt }] });
                await saveChatHistory();
                await getBotResponse();
                messageInput.value = '';
                messageInput.style.height = 'auto';
                setMode('chat');
            }
        });

        function setMode(newMode) {
            currentMode = currentMode === newMode ? 'chat' : newMode;
            updateUIForMode();
        }

        function updateUIForMode() {
            featureButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-gray-300');
            });
            
            switch (currentMode) {
                case 'brainstorm':
                    brainstormBtn.classList.add('active');
                    brainstormBtn.classList.remove('text-gray-300');
                    messageInput.placeholder = 'What would you like to brainstorm about?';
                    break;
                case 'explain':
                    explainBtn.classList.add('active');
                    explainBtn.classList.remove('text-gray-300');
                    messageInput.placeholder = 'Paste your code here for detailed explanation...';
                    break;
                default:
                    messageInput.placeholder = 'Message El Futuro...';
                    break;
            }
            messageInput.focus();
        }

        function clearChat() {
            chatWindow.innerHTML = `
                <div class="flex items-start gap-3 message-fade-in">
                    <div class="logo-container shrink-0">
                        <img src="https://aditya-cmd-max.github.io/exonovaai/logo1.png" alt="AI Logo" class="logo-img w-9 h-9">
                    </div>
                    <div class="bot-message rounded-xl p-4 max-w-full md:max-w-2xl border border-white/10">
                        <p class="text-gray-200">Hello there! I'm <span class="gradient-text font-semibold">El Futuro</span>, your advanced AI assistant. The chat has been cleared. What would you like to discuss now? üöÄ</p>
                    </div>
                </div>`;
            chatHistory = [{
                role: "model",
                parts: [{ text: "You are El Futuro, an advanced AI assistant created by Aditya Jha. The previous chat has been cleared. Continue assisting the user with their new request." }]
            }];
            saveChatHistory();
            setMode('chat');
        }

        function displayUserMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'flex items-start gap-3 justify-end message-fade-in';
            messageElement.innerHTML = `
                <div class="user-message rounded-xl p-4 max-w-full md:max-w-2xl border border-white/10 backdrop-blur-sm">
                    <p class="text-white">${escapeHtml(message)}</p>
                </div>
                <div class="w-9 h-9 rounded-full bg-gradient-to-r from-blue-600 to-pink-600 flex items-center justify-center font-bold text-white text-xs shrink-0 border border-white/10">You</div>
            `;
            chatWindow.appendChild(messageElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function displayBotMessage(message) {
            const messageContainer = document.createElement('div');
            messageContainer.className = 'flex items-start gap-3 message-fade-in';
            let botMessageContent = '';
            const codeBlockRegex = /```(\w*)\n([\s\S]*?)```/g;
            let lastIndex = 0, match;

            while ((match = codeBlockRegex.exec(message)) !== null) {
                if (match.index > lastIndex) {
                    const textPart = message.substring(lastIndex, match.index).trim();
                    if (textPart) botMessageContent += `<p class="text-gray-200">${formatTextWithLineBreaks(textPart)}</p>`;
                }
                const language = match[1] || 'plaintext';
                const code = match[2];
                const uniqueId = `code-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                botMessageContent += `
                    <div class="code-block bg-gray-900/80 rounded-lg w-full border border-white/10 overflow-hidden">
                        <div class="flex justify-between items-center px-4 py-2 bg-gray-800/50 border-b border-white/10">
                            <span class="text-xs text-gray-400">${language}</span>
                            <button class="copy-btn" onclick="copyCode('${uniqueId}', this)">Copy</button>
                        </div>
                        <pre class="p-4 overflow-x-auto text-sm"><code id="${uniqueId}" class="language-${language}">${escapeHtml(code)}</code></pre>
                    </div>`;
                lastIndex = match.index + match[0].length;
            }

            if (lastIndex < message.length) {
                const textPart = message.substring(lastIndex).trim();
                if (textPart) botMessageContent += `<p class="text-gray-200">${formatTextWithLineBreaks(textPart)}</p>`;
            }

            messageContainer.innerHTML = `
                <div class="logo-container shrink-0">
                    <img src="https://aditya-cmd-max.github.io/exonovaai/logo1.png" alt="AI Logo" class="logo-img w-9 h-9">
                </div>
                <div class="bot-message rounded-xl p-4 max-w-full md:max-w-2xl border border-white/10">
                    ${botMessageContent}
                </div>`;
            chatWindow.appendChild(messageContainer);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function formatTextWithLineBreaks(text) {
            // Replace double newlines with paragraphs
            let formattedText = text.replace(/\n\n/g, '</p><p class="text-gray-200">');
            // Replace single newlines with line breaks
            formattedText = formattedText.replace(/\n/g, '<br>');
            return formattedText;
        }

        function displayTypingIndicator() {
            const typingElement = document.createElement('div');
            typingElement.id = 'typing-indicator';
            typingElement.className = 'flex items-start gap-3 message-fade-in';
            typingElement.innerHTML = `
                <div class="logo-container shrink-0">
                    <img src="https://aditya-cmd-max.github.io/exonovaai/logo1.png" alt="AI Logo" class="logo-img w-9 h-9">
                </div>
                <div class="bot-message rounded-xl p-4 max-w-full md:max-w-2xl border border-white/10">
                    <div class="flex items-center space-x-2">
                        <div class="typing-dot w-2 h-2 bg-pink-400 rounded-full"></div>
                        <div class="typing-dot w-2 h-2 bg-blue-400 rounded-full"></div>
                        <div class="typing-dot w-2 h-2 bg-pink-400 rounded-full"></div>
                    </div>
                </div>`;
            chatWindow.appendChild(typingElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) typingIndicator.remove();
        }

        async function getBotResponse() {
            displayTypingIndicator();
            const apiKey = "AIzaSyDumsAxfOETUy3E85Qp_ikVSglQmeoXrJk";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: chatHistory };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                }

                const result = await response.json();
                removeTypingIndicator();

                if (result.candidates?.length > 0) {
                    const botMessage = result.candidates[0].content.parts[0].text;
                    displayBotMessage(botMessage);
                    chatHistory.push({ role: "model", parts: [{ text: botMessage }] });
                    await saveChatHistory();
                } else {
                    handleApiError("I received an empty response. Please try rephrasing your question. ü§î");
                }
            } catch (error) {
                console.error("API Error:", error);
                handleApiError(`Sorry, I'm having trouble responding right now. Please try again later. (Error: ${error.message})`);
            }
        }

        function handleApiError(message) {
            removeTypingIndicator();
            displayBotMessage(message);
            chatHistory.push({ role: "model", parts: [{ text: message }] });
            saveChatHistory();
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        window.copyCode = function(elementId, buttonElement) {
            const codeElement = document.getElementById(elementId);
            navigator.clipboard.writeText(codeElement.innerText).then(() => {
                buttonElement.innerText = "Copied!";
                buttonElement.classList.add('copied');
                setTimeout(() => {
                    buttonElement.innerText = "Copy";
                    buttonElement.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
                buttonElement.innerText = "Error!";
                setTimeout(() => {
                    buttonElement.innerText = "Copy";
                }, 2000);
            });
        }
    </script>
</body>
</html>
