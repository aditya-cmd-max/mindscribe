<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Chat App</title>
    <!-- Use a modern, easy-to-read font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-color: #6366F1;
            --primary-light: #C7D2FE;
            --background-color: #F8FAFC;
            --chat-bg-dark: #E2E8F0;
            --chat-bg-light: #E0E7FF;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
        }

        /* Hide scrollbar for a cleaner look */
        .chat-container::-webkit-scrollbar {
            display: none;
        }

        .chat-container {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 md:p-8">

    <!-- Main application container -->
    <div class="w-full max-w-2xl bg-white rounded-3xl shadow-2xl overflow-hidden flex flex-col h-[80vh]">

        <!-- Header -->
        <header class="bg-indigo-600 text-white p-4 md:p-5 flex justify-between items-center shadow-lg">
            <h1 class="text-xl md:text-2xl font-bold">Collaborative Chat</h1>
            <div id="user-id-display" class="bg-indigo-700 text-xs md:text-sm font-mono px-3 py-1 rounded-full opacity-80">
                User ID: <span id="user-id-text">Loading...</span>
            </div>
        </header>

        <!-- Chat messages container -->
        <main id="chat-messages" class="flex-grow p-4 overflow-y-auto chat-container space-y-4">
            <!-- Messages will be dynamically inserted here -->
            <div id="loading-indicator" class="text-center text-gray-500 mt-10">
                <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2">Connecting...</p>
            </div>
        </main>

        <!-- Message input area -->
        <footer class="p-4 md:p-5 bg-gray-50 border-t border-gray-200">
            <div class="flex space-x-3">
                <input type="text" id="message-input" placeholder="Type a message..."
                       class="flex-grow p-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-gray-800">
                <button id="send-button"
                        class="bg-indigo-600 text-white p-3 rounded-full shadow-lg hover:bg-indigo-700 transition-all duration-300 transform active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                    </svg>
                </button>
            </div>
        </footer>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase services
        let app, db, auth;
        let userId;

        // --- REPLACE THE FOLLOWING WITH YOUR OWN FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyB7F1uRRiGdw489c_18aJeodbxrzsdFb5c",
            authDomain: "exonova-cd89c.firebaseapp.com",
            projectId: "exonova-cd89c",
            storageBucket: "exonova-cd89c.firebasestorage.app",
            messagingSenderId: "465326262278",
            appId: "1:465326262278:web:1b7f8f62e1f46c5ca7db87"
        };
        // -----------------------------------------------------------

        /**
         * Converts a Firestore Timestamp object to a formatted date string.
         * @param {Object} timestamp - The Firestore Timestamp object.
         * @returns {string} The formatted date and time string.
         */
        function formatTimestamp(timestamp) {
            if (!timestamp || !timestamp.seconds) return 'Sending...';
            const date = new Date(timestamp.seconds * 1000);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            let dateString;
            if (date.toDateString() === today.toDateString()) {
                dateString = 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                dateString = 'Yesterday';
            } else {
                dateString = date.toLocaleDateString();
            }

            const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            return `${dateString}, ${timeString}`;
        }

        /**
         * Renders a single message to the UI.
         * @param {Object} message - The message data object.
         * @param {string} message.text - The message text.
         * @param {string} message.userId - The ID of the user who sent the message.
         * @param {Object} message.timestamp - The Firestore Timestamp object.
         * @param {boolean} isCurrentUser - True if the message was sent by the current user.
         */
        function renderMessage(message, isCurrentUser) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-[70%] md:max-w-[60%] p-3 rounded-xl shadow-md transition-all duration-200 ease-in-out transform` +
                ` ${isCurrentUser ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-bl-none'}`;

            const messageText = document.createElement('p');
            messageText.className = 'break-words text-sm md:text-base';
            messageText.textContent = message.text;

            const messageMeta = document.createElement('div');
            messageMeta.className = `text-xs mt-1 text-right italic ${isCurrentUser ? 'text-indigo-200' : 'text-gray-500'}`;
            
            const senderIdSpan = document.createElement('span');
            senderIdSpan.className = 'font-mono break-all opacity-70';
            senderIdSpan.textContent = isCurrentUser ? 'You' : message.userId.substring(0, 8) + '...';

            const timestampSpan = document.createElement('span');
            timestampSpan.textContent = ` â€¢ ${formatTimestamp(message.timestamp)}`;

            messageMeta.appendChild(senderIdSpan);
            messageMeta.appendChild(timestampSpan);
            
            messageBubble.appendChild(messageText);
            messageBubble.appendChild(messageMeta);
            messageElement.appendChild(messageBubble);

            messagesContainer.appendChild(messageElement);
        }

        /**
         * Clears all messages from the chat container.
         */
        function clearMessages() {
            const messagesContainer = document.getElementById('chat-messages');
            while (messagesContainer.firstChild) {
                messagesContainer.removeChild(messagesContainer.firstChild);
            }
        }

        /**
         * Displays a message box for a specific duration.
         * @param {string} text - The message to display.
         */
        function showMessageBox(text) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageBox = document.createElement('div');
            messageBox.className = 'w-full text-center text-gray-500 italic p-2 rounded-lg bg-gray-100 mb-2';
            messageBox.textContent = text;
            messagesContainer.appendChild(messageBox);
            setTimeout(() => {
                messageBox.remove();
            }, 5000);
        }

        /**
         * Sends a new message to the Firestore database.
         */
        async function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const messageText = messageInput.value.trim();

            if (messageText === '') {
                return; // Do not send empty messages
            }

            // Await authentication before trying to send
            if (!userId) {
                showMessageBox("Please wait, connecting to the server...");
                return;
            }

            try {
                // Add a new document to the 'chat_messages' collection
                const chatCollection = collection(db, `chat_messages`);
                await addDoc(chatCollection, {
                    text: messageText,
                    userId: userId,
                    timestamp: serverTimestamp() // Use a server timestamp for consistency
                });
                
                // Clear the input field after sending
                messageInput.value = '';
                messageInput.focus();

            } catch (e) {
                console.error("Error adding document: ", e);
                showMessageBox("Error sending message. Please try again.");
            }
        }

        /**
         * Initializes Firebase and sets up the real-time listener.
         */
        async function initFirebaseAndChat() {
            // Initialize Firebase services
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Handle user authentication
            await signInAnonymously(auth);

            // Wait for auth state to be ready to get the user ID
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-text').textContent = userId;
                    document.getElementById('loading-indicator').style.display = 'none';

                    // Set up real-time listener for chat messages
                    const chatCollection = collection(db, `chat_messages`);
                    
                    // The onSnapshot listener provides real-time updates.
                    onSnapshot(chatCollection, (querySnapshot) => {
                        const messages = [];
                        querySnapshot.forEach((doc) => {
                            messages.push(doc.data());
                        });

                        // Sort the messages by timestamp in memory (no orderBy)
                        messages.sort((a, b) => {
                            // Check if timestamps are valid before comparing
                            if (a.timestamp && b.timestamp) {
                                return a.timestamp.seconds - b.timestamp.seconds;
                            }
                            // Push items with invalid timestamps to the end
                            return a.timestamp ? -1 : 1; 
                        });

                        clearMessages(); // Clear old messages before rendering new ones
                        messages.forEach(msg => {
                            renderMessage(msg, msg.userId === userId);
                        });

                        // Scroll to the bottom of the chat window
                        const messagesContainer = document.getElementById('chat-messages');
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;

                    }, (error) => {
                        console.error("Error listening for messages: ", error);
                        showMessageBox("Error loading chat messages. Please refresh the page.");
                    });
                } else {
                    userId = null;
                    document.getElementById('user-id-text').textContent = "Not signed in";
                }
            });
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', initFirebaseAndChat);
        document.getElementById('send-button').addEventListener('click', sendMessage);
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

    </script>
</body>
</html>
