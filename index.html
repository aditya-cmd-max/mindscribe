<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mindscribe</title>
    <!-- Load Tailwind CSS from CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Set the Inter font for a modern look -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap">
    <style>
        /* Custom styles for the app's aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c0b1a; /* Dark background */
        }
        .container {
            max-width: 1400px;
            margin: auto;
        }
        /* Custom scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a2e; /* Dark scrollbar track */
        }
        ::-webkit-scrollbar-thumb {
            background: #4a4a5c; /* Lighter thumb color */
            border-radius: 4px;
        }
        /* Style the login/signup form and the app panels */
        .card {
            background-color: #16152a; /* Dark card background */
            border: 1px solid #2d2d41; /* Subtle border */
        }
        /* Make textarea and inputs feel cohesive with the design */
        textarea, input[type="text"], input[type="email"], input[type="password"] {
            background-color: #1a1a2e;
            color: #d1d5db; /* Light gray text */
            border: 1px solid #3d3d52;
        }
        textarea:focus, input:focus {
            border-color: #4f46e5;
            outline: none;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5);
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">
    <div id="loading-spinner" class="flex items-center justify-center min-h-screen">
        <svg class="animate-spin h-12 w-12 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <h2 class="text-xl font-semibold ml-4 text-gray-400">Loading Mindscribe...</h2>
    </div>

    <!-- Main Authentication Form -->
    <div id="auth-container" class="hidden flex items-center justify-center min-h-screen p-4">
        <div class="card p-8 rounded-2xl shadow-2xl w-full max-w-sm transition-all duration-300 transform scale-100 opacity-100">
            <h2 class="text-4xl font-extrabold text-center mb-6 text-indigo-500">Mindscribe</h2>
            <div id="message-box" class="hidden mt-4 p-3 rounded-lg text-sm text-white bg-red-600 text-center shadow-lg"></div>
            <div class="space-y-4">
                <input id="email-input" type="email" placeholder="Email" class="w-full p-3 rounded-lg text-white placeholder-gray-500 transition-colors duration-200">
                <input id="password-input" type="password" placeholder="Password" class="w-full p-3 rounded-lg text-white placeholder-gray-500 transition-colors duration-200">
                <button id="auth-button" class="w-full p-3 rounded-lg font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-lg transform active:scale-95">Login</button>
            </div>
            <p id="toggle-auth" class="text-center mt-4 text-gray-500 text-sm cursor-pointer hover:underline transition-colors duration-200">Don't have an account? Sign Up</p>
        </div>
    </div>

    <!-- Main App Dashboard -->
    <div id="app-container" class="hidden flex min-h-screen flex-col lg:flex-row">
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-80 bg-gray-900 shadow-xl border-r border-gray-800 lg:static lg:flex lg:flex-col p-6 transition-transform duration-300 transform -translate-x-full lg:translate-x-0">
            <div class="flex lg:hidden items-center justify-between mb-4">
                <h1 class="text-2xl font-extrabold text-indigo-500">Mindscribe</h1>
                <button id="close-sidebar-btn" class="p-2 rounded-lg text-white hover:bg-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l5.47 5.47a.75.75 0 11-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z" clip-rule="evenodd" /></svg>
                </button>
            </div>
            <h1 class="hidden lg:block text-3xl font-extrabold mb-6 text-indigo-500">Mindscribe</h1>
            <div class="flex flex-col items-center mb-6 p-4 rounded-xl bg-gray-800 shadow-inner">
                <span class="text-sm text-gray-400 font-medium">User ID:</span>
                <span id="user-id" class="text-xs truncate font-mono text-gray-300 mt-1"></span>
                <button id="logout-btn" class="w-full px-4 py-2 mt-3 rounded-lg text-sm font-semibold bg-red-600 hover:bg-red-700 transition-colors duration-200 text-white shadow-md transform active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 inline-block mr-2"><path fill-rule="evenodd" d="M12 2.25a.75.75 0 01.75.75v9a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M6.162 4.416a.75.75 0 010 1.06l-2.094 2.094c-.4.4-.648.943-.648 1.547v.643a3.75 3.75 0 003.75 3.75h7.5c2.09 0 3.826-1.544 3.75-3.633a.75.75 0 011.5-.067c.074 2.457-1.802 4.444-4.25 4.444h-7.5c-2.448 0-4.25-1.987-4.25-4.444v-.643a3.75 3.75 0 01.648-1.547l2.094-2.094a.75.75 0 011.06 0z" clip-rule="evenodd" /></svg>
                    Logout
                </button>
            </div>
            
            <!-- New Notebook Section -->
            <div class="mb-6">
                <button id="toggle-notebook-form-btn" class="w-full p-3 rounded-lg font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md flex items-center justify-center transform active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 mr-2"><path d="M19.5 21a3 3 0 003-3v-4.5a3 3 0 00-3-3h-15a3 3 0 00-3 3V18a3 3 0 003 3h15zM1.5 10.146a3 3 0 013-3h15.002a3 3 0 013 3V12a3 3 0 00-3-3h-15a3 3 0 00-3 3v-1.854z" /><path d="M12 12.75a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0v-3.75a.75.75 0 01.75-.75zM15.75 13.5a.75.75 0 00-1.5 0v3.75a.75.75 0 001.5 0v-3.75zM8.25 13.5a.75.75 0 00-1.5 0v3.75a.75.75 0 001.5 0v-3.75z" /></svg>
                    New Notebook
                </button>
                <form id="notebook-form" class="mt-3 hidden">
                    <input id="new-notebook-name" type="text" placeholder="Notebook name" class="w-full p-3 rounded-l-lg bg-gray-800 text-white placeholder-gray-500 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button type="submit" class="p-3 rounded-r-lg bg-indigo-600 hover:bg-indigo-700 text-white font-bold transition-colors shadow-md transform active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zM12.75 9a.75.75 0 00-1.5 0v2.25H9a.75.75 0 000 1.5h2.25V15a.75.75 0 001.5 0v-2.25H15a.75.75 0 000-1.5h-2.25V9z" clip-rule="evenodd" /></svg>
                    </button>
                </form>
            </div>
            
            <!-- Notebook List -->
            <nav class="flex-grow overflow-y-auto pr-2 mb-6 space-y-2">
                <h2 class="text-xl font-bold mb-3 text-white">Notebooks</h2>
                <ul id="notebooks-list" class="space-y-2">
                    <!-- Notebook items will be rendered here by JavaScript -->
                </ul>
            </nav>
            
            <!-- New Note Button -->
            <div class="mt-auto">
                <button id="create-note-btn" class="w-full p-3 rounded-lg font-bold text-white bg-green-600 hover:bg-green-700 transition-colors duration-200 shadow-md flex items-center justify-center transform active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 mr-2"><path d="M19.5 21a3 3 0 003-3v-4.5a3 3 0 00-3-3h-15a3 3 0 00-3 3V18a3 3 0 003 3h15zM1.5 10.146a3 3 0 013-3h15.002a3 3 0 013 3V12a3 3 0 00-3-3h-15a3 3 0 00-3 3v-1.854z" /></svg>
                    New Note
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-grow p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Mobile sidebar toggle button -->
            <button id="open-sidebar-btn" class="lg:hidden fixed bottom-4 right-4 z-40 p-3 rounded-full bg-indigo-600 text-white shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M3 6.75A.75.75 0 013.75 6h16.5a.75.75 0 010 1.5H3.75A.75.75 0 013 6.75zM3 12a.75.75 0 01.75-.75h16.5a.75.75 0 010 1.5H3.75A.75.75 0 013 12zm0 5.25a.75.75 0 01.75-.75h16.5a.75.75 0 010 1.5H3.75a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg>
            </button>
            
            <!-- Notes List Panel -->
            <div class="lg:col-span-1 p-6 rounded-2xl bg-gray-900 shadow-2xl border border-gray-800 flex flex-col h-[calc(100vh-48px)] lg:h-full overflow-y-auto">
                <h2 class="text-2xl font-bold mb-4 text-white">Notes</h2>
                <ul id="notes-list" class="space-y-2 flex-grow overflow-y-auto pr-2">
                    <!-- Note items will be rendered here by JavaScript -->
                </ul>
            </div>
            
            <!-- Note Editor and AI Assistant Panels -->
            <div class="lg:col-span-2 flex flex-col gap-6 h-[calc(100vh-48px)] lg:h-full">
                <!-- Note Editor -->
                <div class="p-6 rounded-2xl bg-gray-900 shadow-2xl border border-gray-800 flex-grow flex flex-col">
                    <div id="editor-container" class="flex flex-col h-full">
                        <div id="no-note-selected-message" class="flex items-center justify-center h-full text-center text-gray-500">
                            <p class="text-xl font-medium">Select a note or create a new one.</p>
                        </div>
                        <input id="note-title" type="text" placeholder="Note Title" class="hidden text-3xl font-bold w-full bg-transparent outline-none text-white placeholder-gray-500 mb-4">
                        <textarea id="note-content" placeholder="Start writing..." class="hidden flex-grow p-4 rounded-xl bg-gray-800 text-white resize-none outline-none focus:ring-2 focus:ring-indigo-500 w-full"></textarea>
                        <div id="editor-buttons" class="hidden flex flex-wrap gap-4 mt-4">
                            <button id="delete-note-btn" class="flex-1 px-6 py-3 rounded-lg text-white bg-red-600 hover:bg-red-700 transition-colors duration-200 font-bold shadow-md transform active:scale-95 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 mr-2"><path fill-rule="evenodd" d="M16.5 4.478a.75.75 0 01.424.085l5.25 2.75a.75.75 0 01.32.966l-1.892 3.635a.75.75 0 01-1.018.354L15 8.447V18a3 3 0 01-3 3H5.25A2.25 2.25 0 013 18V4.75a.75.75 0 011.5 0v13.5a.75.75 0 00.75.75h9.75a.75.75 0 00.75-.75V8.447l.583-.284a.75.75 0 01.424.085z" clip-rule="evenodd" /><path d="M10.125 3.004a1.875 1.875 0 10-3.75 0v2.25h3.75V3.004z" /></svg>
                                Delete
                            </button>
                            <button id="export-note-btn" class="flex-1 px-6 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-bold transition-colors duration-200 shadow-md transform active:scale-95 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 mr-2"><path d="M19.5 21a3 3 0 003-3v-4.5a3 3 0 00-3-3h-15a3 3 0 00-3 3V18a3 3 0 003 3h15zM1.5 10.146a3 3 0 013-3h15.002a3 3 0 013 3V12a3 3 0 00-3-3h-15a3 3 0 00-3 3v-1.854z" /></svg>
                                Export
                            </button>
                        </div>
                    </div>
                </div>
            
                <!-- AI Assistant -->
                <div class="p-6 rounded-2xl bg-gray-900 shadow-2xl border border-gray-800 flex flex-col flex-grow">
                    <h3 class="text-2xl font-bold mb-4 text-white flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mr-2 text-indigo-400"><path fill-rule="evenodd" d="M9.401 3.003c1.155-2.003 4.043-2.003 5.198 0 .426.74.9 1.503 1.35 2.28.45.778.855 1.583 1.256 2.404C18.397 8.846 20.505 10 22.5 10c-2.235 0-4.47-.615-5.647-1.758a.75.75 0 00-1.026-.008c-1.127 1.09-2.673 1.666-4.507 1.666S6.173 9.342 5.046 8.258a.75.75 0 00-1.025.008C2.5 9.385.25 10 .25 10c1.995 0 4.103-1.154 5.344-3.113A.75.75 0 006.5 6.48a.75.75 0 00-.077-1.189A.75.75 0 006 5.25c.036-.08.07-.156.108-.23c.307-.583.63-.645.92-.68a.75.75 0 00.75-1.391z" clip-rule="evenodd" /><path d="M12 11.25a.75.75 0 01.75.75v5.25a.75.75 0 01-1.5 0V12a.75.75 0 01.75-.75z" /><path d="M15.75 12a.75.75 0 00-1.5 0v5.25a.75.75 0 001.5 0V12zM8.25 12a.75.75 0 00-1.5 0v5.25a.75.75 0 001.5 0V12z" /></svg>
                        AI Assistant
                    </h3>
                    <div id="ai-response" class="flex-grow overflow-y-auto mb-4 p-4 rounded-xl bg-gray-800 text-gray-400">
                        Ask AI a question or request a summary here...
                    </div>
                    <div class="flex gap-4 mt-auto">
                        <input id="ai-prompt-input" type="text" placeholder="Ask AI a question..." class="flex-grow p-3 rounded-lg border border-gray-700 bg-gray-800 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button id="ai-send-btn" class="px-6 py-3 rounded-lg font-bold text-white transition-colors duration-200 shadow-md transform active:scale-95 bg-indigo-600 hover:bg-indigo-700">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M10.5 8.25L14.25 12L10.5 15.75L12 18L18 12L12 6L10.5 8.25Z" fill="#FFFFFF"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // Import all required Firebase modules from a CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB7F1uRRiGdw489c_18aJeodbxrzsdFb5c",
            authDomain: "exonova-cd89c.firebaseapp.com",
            projectId: "exonova-cd89c",
            storageBucket: "exonova-cd89c.firebasestorage.app",
            messagingSenderId: "465326262278",
            appId: "1:465326262278:web:1b7f8f62e1f46c5ca7db87",
            measurementId: "G-GGG45V0PEF"
        };
        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase services
        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);

        // --- DOM Elements ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const authButton = document.getElementById('auth-button');
        const toggleAuthBtn = document.getElementById('toggle-auth');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const messageBox = document.getElementById('message-box');
        const logoutBtn = document.getElementById('logout-btn');
        const userIdSpan = document.getElementById('user-id');
        const sidebar = document.getElementById('sidebar');
        const openSidebarBtn = document.getElementById('open-sidebar-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const notebooksList = document.getElementById('notebooks-list');
        const toggleNotebookFormBtn = document.getElementById('toggle-notebook-form-btn');
        const notebookForm = document.getElementById('notebook-form');
        const newNotebookNameInput = document.getElementById('new-notebook-name');
        const createNoteBtn = document.getElementById('create-note-btn');
        const notesList = document.getElementById('notes-list');
        const editorContainer = document.getElementById('editor-container');
        const noNoteSelectedMessage = document.getElementById('no-note-selected-message');
        const noteTitleInput = document.getElementById('note-title');
        const noteContentTextarea = document.getElementById('note-content');
        const editorButtons = document.getElementById('editor-buttons');
        const deleteNoteBtn = document.getElementById('delete-note-btn');
        const exportNoteBtn = document.getElementById('export-note-btn');
        const aiPromptInput = document.getElementById('ai-prompt-input');
        const aiSendBtn = document.getElementById('ai-send-btn');
        const aiResponseDiv = document.getElementById('ai-response');

        // --- Global State ---
        let isLogin = true;
        let userId = null;
        let notebooks = [];
        let notes = [];
        let selectedNotebookId = null;
        let selectedNoteId = null;

        // --- Helper Functions ---
        const showMessage = (msg, isError = false) => {
            messageBox.textContent = msg;
            messageBox.style.backgroundColor = isError ? '#dc2626' : '#10b981';
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        };

        const showUI = (element) => element.classList.remove('hidden');
        const hideUI = (element) => element.classList.add('hidden');

        const renderNotebooks = () => {
            notebooksList.innerHTML = '';
            if (notebooks.length === 0) {
                notebooksList.innerHTML = `<p class="text-gray-500 text-sm text-center">No notebooks. Create one!</p>`;
                return;
            }
            notebooks.forEach(nb => {
                const li = document.createElement('li');
                li.className = `flex items-center justify-between p-3 rounded-xl cursor-pointer transition-all duration-200 shadow-md ${selectedNotebookId === nb.id ? 'bg-indigo-600 text-white' : 'bg-gray-800 hover:bg-gray-700'}`;
                li.innerHTML = `
                    <span class="font-medium truncate">${nb.name}</span>
                    <button class="delete-notebook-btn text-gray-400 hover:text-red-500 transition-colors text-lg font-bold" data-id="${nb.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M16.5 4.478a.75.75 0 01.424.085l5.25 2.75a.75.75 0 01.32.966l-1.892 3.635a.75.75 0 01-1.018.354L15 8.447V18a3 3 0 01-3 3H5.25A2.25 2.25 0 013 18V4.75a.75.75 0 011.5 0v13.5a.75.75 0 00.75.75h9.75a.75.75 0 00.75-.75V8.447l.583-.284a.75.75 0 01.424.085z" clip-rule="evenodd" /><path d="M10.125 3.004a1.875 1.875 0 10-3.75 0v2.25h3.75V3.004z" /></svg>
                    </button>
                `;
                li.addEventListener('click', () => {
                    selectedNotebookId = nb.id;
                    renderNotebooks();
                    // Close sidebar on mobile
                    if (window.innerWidth < 1024) {
                        sidebar.classList.add('-translate-x-full');
                    }
                });
                li.querySelector('.delete-notebook-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteNotebook(nb.id);
                });
                notebooksList.appendChild(li);
            });
        };

        const renderNotes = () => {
            notesList.innerHTML = '';
            if (notes.length === 0) {
                notesList.innerHTML = `<p class="text-gray-500 text-center mt-4">No notes in this notebook. Create one!</p>`;
                showNoteEditor(null);
                return;
            }
            // Sort notes by last updated time
            notes.sort((a, b) => (b.updatedAt?.toDate()?.getTime() || 0) - (a.updatedAt?.toDate()?.getTime() || 0));

            notes.forEach(note => {
                const li = document.createElement('li');
                li.className = `p-4 rounded-xl cursor-pointer shadow-md transition-all duration-200 ${selectedNoteId === note.id ? 'bg-indigo-600 text-white' : 'bg-gray-800 hover:bg-gray-700'}`;
                const updatedAt = note.updatedAt ? new Date(note.updatedAt.toDate()).toLocaleString() : 'N/A';
                li.innerHTML = `
                    <h3 class="font-semibold text-lg ${selectedNoteId === note.id ? '' : 'text-white'}">${note.title || 'Untitled Note'}</h3>
                    <p class="text-sm ${selectedNoteId === note.id ? 'text-gray-200' : 'text-gray-400'}">${updatedAt}</p>
                `;
                li.addEventListener('click', () => {
                    selectedNoteId = note.id;
                    showNoteEditor(note);
                    renderNotes();
                });
                notesList.appendChild(li);
            });
            const noteToDisplay = notes.find(n => n.id === selectedNoteId);
            showNoteEditor(noteToDisplay);
        };
        
        const showNoteEditor = (note) => {
            if (note) {
                hideUI(noNoteSelectedMessage);
                showUI(noteTitleInput);
                showUI(noteContentTextarea);
                showUI(editorButtons);
                noteTitleInput.value = note.title || '';
                noteContentTextarea.value = note.content || '';
            } else {
                showUI(noNoteSelectedMessage);
                hideUI(noteTitleInput);
                hideUI(noteContentTextarea);
                hideUI(editorButtons);
            }
        };

        // --- Firebase Functions ---
        const handleAuth = async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            if (!email || !password) {
                showMessage("Email and password cannot be empty.", true);
                return;
            }
            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                showMessage(error.message, true);
            }
        };

        const handleLogout = () => signOut(auth);

        const createNotebook = async (e) => {
            e.preventDefault();
            const name = newNotebookNameInput.value.trim();
            if (!name) {
                showMessage("Notebook name cannot be empty.", true);
                return;
            }
            try {
                const notebooksRef = collection(db, 'artifacts', appId, 'users', userId, 'notebooks');
                await addDoc(notebooksRef, { name, createdAt: new Date() });
                newNotebookNameInput.value = '';
                hideUI(notebookForm);
            } catch (e) {
                console.error("Error creating notebook: ", e);
                showMessage("Failed to create notebook.", true);
            }
        };

        const deleteNotebook = async (notebookId) => {
            if (!confirm("Are you sure you want to delete this notebook and all its notes?")) return;
            try {
                const batch = writeBatch(db);
                const notesRef = collection(db, 'artifacts', appId, 'users', userId, 'notes');
                const q = query(notesRef, where('notebookId', '==', notebookId));
                const querySnapshot = await getDocs(q);
                querySnapshot.docs.forEach(noteDoc => {
                    batch.delete(doc(notesRef, noteDoc.id));
                });
                batch.delete(doc(db, 'artifacts', appId, 'users', userId, 'notebooks', notebookId));
                await batch.commit();
            } catch (e) {
                console.error("Error deleting notebook: ", e);
                showMessage("Failed to delete notebook.", true);
            }
        };
        
        const createNote = async () => {
            if (!selectedNotebookId) {
                showMessage("Please select or create a notebook first.", true);
                return;
            }
            try {
                const notesRef = collection(db, 'artifacts', appId, 'users', userId, 'notes');
                const newDoc = await addDoc(notesRef, {
                    title: 'New Note',
                    content: '',
                    notebookId: selectedNotebookId,
                    createdAt: new Date(),
                    updatedAt: new Date()
                });
                selectedNoteId = newDoc.id;
            } catch (e) {
                console.error("Error creating note: ", e);
                showMessage("Failed to create note.", true);
            }
        };

        const updateNote = async (id, updatedFields) => {
            try {
                const noteRef = doc(db, 'artifacts', appId, 'users', userId, 'notes', id);
                await updateDoc(noteRef, { ...updatedFields, updatedAt: new Date() });
            } catch (e) {
                console.error("Error updating note: ", e);
                showMessage("Failed to update note.", true);
            }
        };

        const deleteNote = async () => {
            if (!selectedNoteId || !confirm("Are you sure you want to delete this note?")) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'notes', selectedNoteId));
            } catch (e) {
                console.error("Error deleting note: ", e);
                showMessage("Failed to delete note.", true);
            }
        };

        const handleExport = () => {
            const note = notes.find(n => n.id === selectedNoteId);
            if (!note) return;
            const markdownContent = `# ${note.title}\n\n${note.content}`;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = markdownContent;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);
            showMessage("Note content copied to clipboard!");
        };

        const handleAiRequest = async () => {
            const aiPrompt = aiPromptInput.value.trim();
            if (!aiPrompt) return;
            aiSendBtn.disabled = true;
            aiSendBtn.textContent = 'Thinking...';
            aiResponseDiv.textContent = 'Thinking...';

            const note = notes.find(n => n.id === selectedNoteId);
            const promptWithContext = note
                ? `Based on the following note content: "${note.content}", please answer this request: ${aiPrompt}`
                : aiPrompt;

            const chatHistory = [{ role: "user", parts: [{ text: promptWithContext }] }];
            const payload = { contents: chatHistory };
            const apiKey = "AIzaSyAFbJJ4Q16Uh-CVC36kao3XTDOUUtc6VGo"
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let resultText = "Failed to get a response from the AI. Please try again.";
            let retries = 0;
            const maxRetries = 3;
            const initialDelay = 1000;

            while (retries < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                        resultText = result.candidates[0].content.parts[0].text;
                        break; // Success, exit the retry loop
                    } else {
                        throw new Error("Unexpected response structure from the API.");
                    }
                } catch (error) {
                    console.error(`Attempt ${retries + 1} failed:`, error);
                    retries++;
                    if (retries < maxRetries) {
                        const delay = initialDelay * Math.pow(2, retries - 1);
                        await new Promise(res => setTimeout(res, delay));
                    }
                }
            }

            aiResponseDiv.textContent = resultText;
            aiSendBtn.disabled = false;
            aiSendBtn.textContent = 'Send';
            aiPromptInput.value = '';
        };

        // --- Event Listeners ---
        window.addEventListener('load', () => {
            // Sign-in with the custom token provided by the canvas environment
            const handleSignIn = async () => {
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } catch (error) {
                        console.error("Error signing in with custom token:", error);
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
            };
            handleSignIn();
        });

        onAuthStateChanged(auth, (user) => {
            hideUI(loadingSpinner);
            if (user) {
                userId = user.uid;
                userIdSpan.textContent = userId;
                showUI(appContainer);
                hideUI(authContainer);
                setupFirestoreListeners();
            } else {
                userId = null;
                showUI(authContainer);
                hideUI(appContainer);
            }
        });

        const setupFirestoreListeners = () => {
            // Listener for notebooks
            const notebooksRef = collection(db, 'artifacts', appId, 'users', userId, 'notebooks');
            onSnapshot(notebooksRef, (snapshot) => {
                notebooks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (notebooks.length > 0 && (!selectedNotebookId || !notebooks.some(nb => nb.id === selectedNotebookId))) {
                    selectedNotebookId = notebooks[0].id;
                } else if (notebooks.length === 0) {
                    selectedNotebookId = null;
                }
                renderNotebooks();
            });

            // Listener for notes
            const notesRef = collection(db, 'artifacts', appId, 'users', userId, 'notes');
            onSnapshot(notesRef, (snapshot) => {
                notes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const filteredNotes = notes.filter(n => n.notebookId === selectedNotebookId);
                
                // If the selected note is not in the filtered list, select the first one
                if (filteredNotes.length > 0 && (!selectedNoteId || !filteredNotes.some(n => n.id === selectedNoteId))) {
                    selectedNoteId = filteredNotes[0].id;
                } else if (filteredNotes.length === 0) {
                    selectedNoteId = null;
                }

                notes = filteredNotes;
                renderNotes();
            });
        };

        // Auth listeners
        authButton.addEventListener('click', handleAuth);
        toggleAuthBtn.addEventListener('click', () => {
            isLogin = !isLogin;
            authButton.textContent = isLogin ? 'Login' : 'Sign Up';
            toggleAuthBtn.textContent = isLogin ? "Don't have an account? Sign Up" : "Already have an account? Login";
        });
        logoutBtn.addEventListener('click', handleLogout);

        // Sidebar listeners
        openSidebarBtn.addEventListener('click', () => sidebar.classList.remove('-translate-x-full'));
        closeSidebarBtn.addEventListener('click', () => sidebar.classList.add('-translate-x-full'));

        // Notebook listeners
        toggleNotebookFormBtn.addEventListener('click', () => notebookForm.classList.toggle('hidden'));
        notebookForm.addEventListener('submit', createNotebook);

        // Note listeners
        createNoteBtn.addEventListener('click', createNote);
        noteTitleInput.addEventListener('input', () => {
            const currentNote = notes.find(n => n.id === selectedNoteId);
            if (currentNote) {
                updateNote(selectedNoteId, { title: noteTitleInput.value });
            }
        });
        noteContentTextarea.addEventListener('input', () => {
            const currentNote = notes.find(n => n.id === selectedNoteId);
            if (currentNote) {
                updateNote(selectedNoteId, { content: noteContentTextarea.value });
            }
        });
        deleteNoteBtn.addEventListener('click', deleteNote);
        exportNoteBtn.addEventListener('click', handleExport);

        // AI Assistant listeners
        aiSendBtn.addEventListener('click', handleAiRequest);
        aiPromptInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                handleAiRequest();
            }
        });
    </script>
</body>
</html>
