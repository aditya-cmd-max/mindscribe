<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mindscribe - AI-Powered Learning Notebook</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Product+Sans:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="https://aditya-cmd-max.github.io/mindscribe/logo.png">
    
    <style>
       /* Material Design 3 Color System */
        :root {
            /* Primary Colors */
            --md-primary: #6750A4;
            --md-on-primary: #FFFFFF;
            --md-primary-container: #EADDFF;
            --md-on-primary-container: #21005D;
            
            /* Secondary Colors */
            --md-secondary: #625B71;
            --md-on-secondary: #FFFFFF;
            --md-secondary-container: #E8DEF8;
            --md-on-secondary-container: #1D192B;
            
            /* Tertiary Colors */
            --md-tertiary: #7D5260;
            --md-on-tertiary: #FFFFFF;
            --md-tertiary-container: #FFD8E4;
            --md-on-tertiary-container: #31111D;
            
            /* Surface Colors */
            --md-surface: #FEF7FF;
            --md-on-surface: #1C1B1F;
            --md-surface-variant: #E7E0EC;
            --md-on-surface-variant: #49454F;
            
            /* Background Colors */
            --md-background: #FEF7FF;
            --md-on-background: #1C1B1F;
            
            /* Error Colors */
            --md-error: #B3261E;
            --md-on-error: #FFFFFF;
            --md-error-container: #F9DEDC;
            --md-on-error-container: #410E0B;
            
            /* Outline Colors */
            --md-outline: #79747E;
            --md-outline-variant: #C4C7C5;
            
            /* Shadow Elevations */
            --md-elevation-1: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            --md-elevation-2: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 2px 6px 2px rgba(0, 0, 0, 0.15);
            --md-elevation-3: 0px 4px 8px 3px rgba(0, 0, 0, 0.15), 0px 1px 3px rgba(0, 0, 0, 0.3);
            --md-elevation-4: 0px 6px 10px 4px rgba(0, 0, 0, 0.15), 0px 2px 3px rgba(0, 0, 0, 0.3);
            --md-elevation-5: 0px 8px 12px 6px rgba(0, 0, 0, 0.15), 0px 4px 4px rgba(0, 0, 0, 0.3);
            
            /* Animation */
            --md-transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
            --md-transition-fast: all 0.15s cubic-bezier(0.2, 0, 0, 1);
            
            /* Border Radius */
            --md-radius-small: 8px;
            --md-radius-medium: 12px;
            --md-radius-large: 16px;
            --md-radius-extra-large: 28px;
            
            /* Spacing */
            --md-spacing-xs: 4px;
            --md-spacing-sm: 8px;
            --md-spacing-md: 16px;
            --md-spacing-lg: 24px;
            --md-spacing-xl: 32px;
            
            /* Typography */
            --md-font-family: 'Product Sans', sans-serif;
            --md-font-size-display: 3.5625rem;
            --md-font-size-headline: 2rem;
            --md-font-size-title: 1.375rem;
            --md-font-size-body: 1rem;
            --md-font-size-label: 0.875rem;
        }

        /* Dark Theme */
        .dark-theme {
            --md-surface: #141218;
            --md-on-surface: #E6E1E5;
            --md-surface-variant: #49454F;
            --md-on-surface-variant: #CAC4D0;
            --md-background: #141218;
            --md-on-background: #E6E1E5;
            --md-primary-container: #4F378B;
            --md-on-primary-container: #EADDFF;
            --md-secondary-container: #4A4458;
            --md-on-secondary-container: #E8DEF8;
        }

        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--md-font-family);
            background-color: var(--md-background);
            color: var(--md-on-surface);
            line-height: 1.5;
            overflow: hidden;
            height: 100vh;
            transition: var(--md-transition);
        }

        /* App Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: var(--md-background);
        }

        /* Header */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--md-spacing-md) var(--md-spacing-lg);
            background: var(--md-surface);
            border-bottom: 1px solid var(--md-outline-variant);
            position: relative;
            z-index: 10;
            height: 64px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: var(--md-spacing-md);
        }

        .logo {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--md-primary);
            border-radius: var(--md-radius-medium);
            color: var(--md-on-primary);
            overflow: hidden;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .app-name {
            font-size: var(--md-font-size-title);
            font-weight: 500;
            color: var(--md-on-surface);
            letter-spacing: -0.25px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--md-spacing-sm);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--md-spacing-sm);
            padding: var(--md-spacing-sm) var(--md-spacing-md);
            border-radius: var(--md-radius-extra-large);
            border: none;
            font-family: inherit;
            font-size: var(--md-font-size-label);
            font-weight: 500;
            cursor: pointer;
            transition: var(--md-transition-fast);
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: currentColor;
            opacity: 0;
            transition: var(--md-transition-fast);
        }

        .btn:hover::before {
            opacity: 0.08;
        }

        .btn:active::before {
            opacity: 0.12;
        }

        .btn-filled {
            background: var(--md-primary);
            color: var(--md-on-primary);
            box-shadow: var(--md-elevation-1);
        }

        .btn-filled:hover {
            box-shadow: var(--md-elevation-2);
        }

        .btn-tonal {
            background: var(--md-secondary-container);
            color: var(--md-on-secondary-container);
        }

        .btn-outlined {
            background: transparent;
            color: var(--md-primary);
            border: 1px solid var(--md-outline);
        }

        .btn-text {
            background: transparent;
            color: var(--md-primary);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--md-surface);
            border-right: 1px solid var(--md-outline-variant);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: var(--md-transition);
            z-index: 5;
            flex-shrink: 0;
            position: relative;
        }

        .sidebar-resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            cursor: col-resize;
            z-index: 10;
            transition: background-color 0.2s;
        }

        .sidebar-resize-handle:hover {
            background-color: var(--md-primary);
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar.collapsed .sidebar-header,
        .sidebar.collapsed .search-container,
        .sidebar.collapsed .notes-list-header,
        .sidebar.collapsed .note-title,
        .sidebar.collapsed .note-preview,
        .sidebar.collapsed .note-meta {
            display: none;
        }

        .sidebar.collapsed .notes-list {
            padding: var(--md-spacing-sm);
        }

        .sidebar.collapsed .note-item {
            padding: var(--md-spacing-sm);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50px;
        }

        .sidebar.collapsed .note-item.selected::after {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 24px;
            background: var(--md-primary);
            border-radius: 0 var(--md-radius-small) var(--md-radius-small) 0;
        }

        .sidebar-header {
            padding: var(--md-spacing-lg);
            border-bottom: 1px solid var(--md-outline-variant);
            transition: var(--md-transition);
        }

        .search-container {
            padding: var(--md-spacing-md) var(--md-spacing-lg);
            border-bottom: 1px solid var(--md-outline-variant);
            transition: var(--md-transition);
        }

        .search-box {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: var(--md-spacing-sm) var(--md-spacing-md) var(--md-spacing-sm) 40px;
            border-radius: var(--md-radius-extra-large);
            border: none;
            background: var(--md-surface-variant);
            color: var(--md-on-surface);
            font-size: var(--md-font-size-body);
            transition: var(--md-transition-fast);
        }

        .search-input:focus {
            outline: 2px solid var(--md-primary);
            outline-offset: 2px;
        }

        .search-icon {
            position: absolute;
            left: var(--md-spacing-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--md-on-surface-variant);
            pointer-events: none;
        }

        .notes-list {
            flex: 1;
            overflow-y: auto;
            padding: var(--md-spacing-md);
            transition: var(--md-transition);
        }

        .notes-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--md-spacing-sm) var(--md-spacing-md);
            margin-bottom: var(--md-spacing-sm);
            transition: var(--md-transition);
        }

        .section-title {
            font-size: var(--md-font-size-label);
            font-weight: 500;
            color: var(--md-on-surface-variant);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .notes-count {
            font-size: var(--md-font-size-label);
            padding: var(--md-spacing-xs) var(--md-spacing-sm);
            background: var(--md-primary-container);
            color: var(--md-on-primary-container);
            border-radius: var(--md-radius-extra-large);
            font-weight: 500;
        }

        .note-item {
            padding: var(--md-spacing-md);
            border-radius: var(--md-radius-medium);
            margin-bottom: var(--md-spacing-sm);
            cursor: pointer;
            transition: var(--md-transition-fast);
            background: var(--md-surface);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .note-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--md-primary);
            opacity: 0;
            transition: var(--md-transition-fast);
        }

        .note-item:hover {
            background: var(--md-surface-variant);
            transform: translateY(-2px);
            box-shadow: var(--md-elevation-1);
        }

        .note-item.selected {
            background: var(--md-primary-container);
            border-color: var(--md-primary);
            transform: translateY(-1px);
            box-shadow: var(--md-elevation-1);
        }

        .note-title {
            font-weight: 500;
            margin-bottom: var(--md-spacing-xs);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            z-index: 1;
            transition: var(--md-transition);
        }

        .note-preview {
            font-size: var(--md-font-size-label);
            color: var(--md-on-surface-variant);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: var(--md-spacing-sm);
            line-height: 1.4;
            position: relative;
            z-index: 1;
            transition: var(--md-transition);
        }

        .note-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--md-on-surface-variant);
            position: relative;
            z-index: 1;
            transition: var(--md-transition);
        }

        .note-tags {
            display: flex;
            gap: var(--md-spacing-xs);
            flex-wrap: wrap;
        }

        .tag {
            background: var(--md-secondary-container);
            color: var(--md-on-secondary-container);
            padding: 2px var(--md-spacing-sm);
            border-radius: var(--md-radius-extra-large);
            font-size: 0.7rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .tag-remove {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 0;
            margin-left: 4px;
        }

        /* Editor */
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--md-background);
            position: relative;
        }

        .editor-header {
            padding: var(--md-spacing-lg);
            border-bottom: 1px solid var(--md-outline-variant);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: var(--md-spacing-md);
            background: var(--md-surface);
        }

        .editor-title-container {
            flex: 1;
        }

        .editor-title {
            font-size: var(--md-font-size-headline);
            font-weight: 400;
            background: transparent;
            border: none;
            color: var(--md-on-surface);
            width: 100%;
            padding: 0;
            letter-spacing: 0;
            resize: none;
            overflow: hidden;
            min-height: 40px;
            line-height: 1.2;
            font-family: var(--md-font-family);
        }

        .editor-title:focus {
            outline: none;
        }

        .editor-actions {
            display: flex;
            gap: var(--md-spacing-sm);
            flex-shrink: 0;
            position: relative;
        }

        .editor-tags {
            padding: var(--md-spacing-md) var(--md-spacing-lg);
            border-bottom: 1px solid var(--md-outline-variant);
            display: flex;
            align-items: center;
            gap: var(--md-spacing-sm);
            flex-wrap: wrap;
            background: var(--md-surface);
            max-height: 120px;
            overflow-y: auto;
        }

        .tag-editor {
            background: var(--md-surface-variant);
            color: var(--md-on-surface);
            border: none;
            border-radius: var(--md-radius-extra-large);
            padding: var(--md-spacing-xs) var(--md-spacing-md);
            font-size: var(--md-font-size-label);
            transition: var(--md-transition-fast);
            min-width: 120px;
            font-family: var(--md-font-family);
        }

        .tag-editor:focus {
            outline: 2px solid var(--md-primary);
            outline-offset: 2px;
        }

        .editor-content {
            flex: 1;
            padding: var(--md-spacing-lg);
            overflow-y: auto;
            background: var(--md-background);
        }

        .note-editor {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            color: var(--md-on-surface);
            resize: none;
            font-size: var(--md-font-size-body);
            line-height: 1.6;
            font-family: var(--md-font-family);
        }

        .note-editor:focus {
            outline: none;
        }

        /* AI Assistant */
        .ai-assistant {
            position: fixed;
            bottom: var(--md-spacing-lg);
            right: var(--md-spacing-lg);
            z-index: 20;
        }

        .ai-fab {
            width: 56px;
            height: 56px;
            border-radius: var(--md-radius-extra-large);
            background: var(--md-primary);
            color: var(--md-on-primary);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--md-elevation-3);
            transition: var(--md-transition);
            position: relative;
            overflow: hidden;
        }

        .ai-fab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: currentColor;
            opacity: 0;
            transition: var(--md-transition-fast);
        }

        .ai-fab:hover {
            box-shadow: var(--md-elevation-4);
            transform: scale(1.05);
        }

        .ai-fab:hover::before {
            opacity: 0.08;
        }

        .ai-fab:active::before {
            opacity: 0.12;
        }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.32);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: var(--md-spacing-lg);
            opacity: 0;
            pointer-events: none;
            transition: var(--md-transition);
            backdrop-filter: blur(8px);
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: var(--md-surface);
            border-radius: var(--md-radius-large);
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: var(--md-elevation-5);
            transform: translateY(20px) scale(0.95);
            transition: var(--md-transition);
            border: 1px solid var(--md-outline-variant);
            display: flex;
            flex-direction: column;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0) scale(1);
        }

        .modal-header {
            padding: var(--md-spacing-lg);
            border-bottom: 1px solid var(--md-outline-variant);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--md-surface);
        }

        .modal-title {
            font-size: var(--md-font-size-title);
            font-weight: 500;
            color: var(--md-on-surface);
            display: flex;
            align-items: center;
            gap: var(--md-spacing-sm);
        }

        .modal-body {
            padding: var(--md-spacing-lg);
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: var(--md-spacing-lg);
        }

        .modal-footer {
            padding: var(--md-spacing-lg);
            border-top: 1px solid var(--md-outline-variant);
            display: flex;
            justify-content: flex-end;
            gap: var(--md-spacing-md);
            background: var(--md-surface);
        }

        /* AI Features */
        .ai-features-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--md-spacing-md);
        }

        .ai-feature-card {
            padding: var(--md-spacing-lg);
            background: var(--md-surface-variant);
            border-radius: var(--md-radius-medium);
            cursor: pointer;
            transition: var(--md-transition-fast);
            border: 1px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: var(--md-spacing-md);
        }

        .ai-feature-card:hover {
            background: var(--md-primary-container);
            border-color: var(--md-primary);
            transform: translateY(-2px);
            box-shadow: var(--md-elevation-1);
        }

        .ai-feature-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--md-radius-medium);
            background: var(--md-primary);
            color: var(--md-on-primary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-feature-title {
            font-weight: 500;
            color: var(--md-on-surface);
        }

        .ai-feature-description {
            font-size: var(--md-font-size-label);
            color: var(--md-on-surface-variant);
        }

        /* AI Response */
        .ai-response {
            background: var(--md-surface-variant);
            padding: var(--md-spacing-lg);
            border-radius: var(--md-radius-medium);
            margin-top: var(--md-spacing-lg);
            border: 1px solid var(--md-outline-variant);
            max-height: 200px;
            overflow-y: auto;
        }

        .ai-response-text {
            white-space: pre-wrap;
            line-height: 1.6;
        }

        /* Loader */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--md-outline-variant);
            border-top: 2px solid var(--md-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: var(--md-spacing-lg);
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: var(--md-spacing-md) var(--md-spacing-lg);
            background: var(--md-surface);
            color: var(--md-on-surface);
            border-radius: var(--md-radius-medium);
            box-shadow: var(--md-elevation-3);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: var(--md-spacing-sm);
            opacity: 0;
            transition: var(--md-transition);
        }

        .notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* More Actions Menu */
        .more-actions-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--md-surface);
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--md-radius-medium);
            box-shadow: var(--md-elevation-3);
            padding: var(--md-spacing-sm);
            min-width: 180px;
            z-index: 100;
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            transition: var(--md-transition);
        }

        .more-actions-menu.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: var(--md-spacing-sm);
            padding: var(--md-spacing-sm) var(--md-spacing-md);
            border: none;
            background: none;
            color: var(--md-on-surface);
            cursor: pointer;
            transition: var(--md-transition-fast);
            width: 100%;
            text-align: left;
            border-radius: var(--md-radius-small);
            font-family: inherit;
            font-size: var(--md-font-size-body);
        }

        .menu-item:hover {
            background: var(--md-surface-variant);
        }

        .menu-divider {
            height: 1px;
            background: var(--md-outline-variant);
            margin: var(--md-spacing-xs) 0;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 280px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                bottom: 0;
                z-index: 20;
                width: 85%;
                max-width: 320px;
                border-radius: 0;
                border-right: 1px solid var(--md-outline-variant);
            }

            .sidebar.active {
                left: 0;
            }

            .overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.32);
                z-index: 15;
                opacity: 0;
                pointer-events: none;
                transition: var(--md-transition);
                backdrop-filter: blur(4px);
            }

            .overlay.active {
                opacity: 1;
                pointer-events: all;
            }

            .menu-toggle {
                display: block !important;
            }

            .app-header {
                padding: var(--md-spacing-md);
            }

            .editor-header {
                padding: var(--md-spacing-md);
            }

            .editor-content {
                padding: var(--md-spacing-md);
            }

            .editor-title {
                font-size: var(--md-font-size-title);
            }

            .editor-tags {
                padding: var(--md-spacing-md);
            }

            .ai-features-grid {
                grid-template-columns: 1fr;
            }

            .ai-fab {
                width: 52px;
                height: 52px;
            }

            .more-actions-menu {
                right: -50px;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .menu-toggle {
            display: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--md-surface-variant);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--md-outline-variant);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--md-outline);
        }

        /* Splash Screen */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--md-background);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--md-spacing-lg);
            transition: opacity 0.5s ease;
        }

        .splash-logo {
            width: 120px;
            height: 120px;
            animation: float 3s ease-in-out infinite;
        }

        .splash-title {
            font-size: var(--md-font-size-headline);
            font-weight: 500;
            color: var(--md-on-surface);
            text-align: center;
        }

        .splash-subtitle {
            font-size: var(--md-font-size-body);
            color: var(--md-on-surface-variant);
            text-align: center;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        /* Advanced Editor Features */
        .editor-toolbar {
            padding: var(--md-spacing-md) var(--md-spacing-lg);
            border-bottom: 1px solid var(--md-outline-variant);
            background: var(--md-surface);
            display: flex;
            gap: var(--md-spacing-sm);
            flex-wrap: wrap;
        }

        .format-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--md-radius-small);
            background: transparent;
            border: none;
            color: var(--md-on-surface-variant);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--md-transition-fast);
        }

        .format-btn:hover {
            background: var(--md-surface-variant);
            color: var(--md-on-surface);
        }

        .format-btn.active {
            background: var(--md-primary-container);
            color: var(--md-primary);
        }

        /* Text formatting styles */
        .bold {
            font-weight: bold;
        }

        .italic {
            font-style: italic;
        }

        .underline {
            text-decoration: underline;
        }

        .underline-straight {
            text-decoration: underline;
        }

        .underline-wavy {
            text-decoration: wavy underline;
        }

        .underline-dotted {
            text-decoration: dotted underline;
        }

        .underline-double {
            text-decoration: double underline;
        }

        /* Export Options */
        .export-options {
            display: flex;
            gap: var(--md-spacing-md);
            margin-top: var(--md-spacing-lg);
        }

        .export-btn {
            flex: 1;
            justify-content: center;
        }

        /* Image Upload Styles */
        .image-upload-container {
            display: flex;
            flex-direction: column;
            gap: var(--md-spacing-md);
            margin-top: var(--md-spacing-lg);
        }

        .image-upload-area {
            border: 2px dashed var(--md-outline-variant);
            border-radius: var(--md-radius-medium);
            padding: var(--md-spacing-lg);
            text-align: center;
            cursor: pointer;
            transition: var(--md-transition);
            background: var(--md-surface-variant);
        }

        .image-upload-area:hover {
            border-color: var(--md-primary);
            background: var(--md-primary-container);
        }

        .image-upload-area.drag-over {
            border-color: var(--md-primary);
            background: var(--md-primary-container);
        }

        .image-upload-icon {
            font-size: 48px;
            color: var(--md-outline);
            margin-bottom: var(--md-spacing-sm);
        }

        .image-upload-text {
            color: var(--md-on-surface);
            margin-bottom: var(--md-spacing-xs);
        }

        .image-upload-hint {
            font-size: var(--md-font-size-label);
            color: var(--md-on-surface-variant);
        }

        .image-upload-btn {
            margin-top: var(--md-spacing-sm);
        }

        .uploaded-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--md-spacing-md);
            margin-top: var(--md-spacing-md);
        }

        .uploaded-image {
            position: relative;
            border-radius: var(--md-radius-medium);
            overflow: hidden;
            aspect-ratio: 1;
        }

        .uploaded-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-actions {
            position: absolute;
            top: var(--md-spacing-xs);
            right: var(--md-spacing-xs);
            display: flex;
            gap: var(--md-spacing-xs);
            opacity: 0;
            transition: var(--md-transition);
        }

        .uploaded-image:hover .image-actions {
            opacity: 1;
        }

        .image-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--md-surface);
            border: none;
            color: var(--md-on-surface);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--md-elevation-1);
            transition: var(--md-transition);
        }

        .image-action-btn:hover {
            background: var(--md-primary);
            color: var(--md-on-primary);
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: var(--md-radius-medium);
            margin: var(--md-spacing-sm) 0;
        }

        /* Image in editor */
        .editor-image {
            max-width: 100%;
            height: auto;
            border-radius: var(--md-radius-medium);
            margin: var(--md-spacing-sm) 0;
            cursor: pointer;
            transition: var(--md-transition);
        }

        .editor-image:hover {
            transform: scale(1.02);
            box-shadow: var(--md-elevation-2);
        }

        /* Image Modal */
        .image-modal {
            max-width: 90vw;
            max-height: 90vh;
        }

        .image-modal .modal-body {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            background: var(--md-surface);
        }

        .image-modal img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* AI Image Analysis Feature */
        .ai-image-feature {
            grid-column: 1 / -1;
        }

        /* Link Styles */
        .editor-link {
            color: var(--md-primary);
            text-decoration: underline;
            cursor: pointer;
        }

        .youtube-embed {
            width: 100%;
            max-width: 560px;
            height: 315px;
            border-radius: var(--md-radius-medium);
            margin: var(--md-spacing-sm) 0;
        }

        .link-input-container {
            display: flex;
            flex-direction: column;
            gap: var(--md-spacing-md);
        }

        .link-input {
            padding: var(--md-spacing-sm) var(--md-spacing-md);
            border-radius: var(--md-radius-medium);
            border: 1px solid var(--md-outline-variant);
            background: var(--md-surface);
            color: var(--md-on-surface);
            font-family: var(--md-font-family);
        }

        .link-input:focus {
            outline: 2px solid var(--md-primary);
            outline-offset: 2px;
        }

        .link-preview {
            padding: var(--md-spacing-md);
            background: var(--md-surface-variant);
            border-radius: var(--md-radius-medium);
            border: 1px solid var(--md-outline-variant);
        }

        .link-preview-title {
            font-weight: 500;
            margin-bottom: var(--md-spacing-xs);
        }

        .link-preview-url {
            font-size: var(--md-font-size-label);
            color: var(--md-on-surface-variant);
            word-break: break-all;
        }

        /* Delete button styles */
        .btn-danger {
            background: var(--md-error) !important;
            color: var(--md-on-error) !important;
        }

        .btn-danger:hover {
            background: var(--md-error) !important;
            opacity: 0.9;
        }
    </style>
</head>
<body class="light-theme">
    <!-- Splash Screen -->
    <div id="splash-screen">
        <img src="https://aditya-cmd-max.github.io/mindscribe/logo.png" alt="Mindscribe Logo" class="splash-logo">
        <h1 class="splash-title">Mindscribe</h1>
        <p class="splash-subtitle">AI-Powered Learning Notebook</p>
        <div class="loader"></div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="main-app" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <div class="logo-container">
                <button class="btn btn-icon menu-toggle">
                    <span class="material-icons-round">menu</span>
                </button>
                <div class="logo">
                    <img src="https://aditya-cmd-max.github.io/mindscribe/logo.png" alt="Mindscribe Logo">
                </div>
                <h1 class="app-name">Mindscribe</h1>
            </div>
            <div class="header-actions">
                <button class="btn btn-text" id="theme-toggle">
                    <span class="material-icons-round">dark_mode</span>
                    <span>Theme</span>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-resize-handle"></div>
                <div class="sidebar-header">
                    <button class="btn btn-filled" id="new-note-btn">
                        <span class="material-icons-round">add</span>
                        <span>New Note</span>
                    </button>
                </div>
                <div class="search-container">
                    <div class="search-box">
                        <span class="material-icons-round search-icon">search</span>
                        <input type="text" class="search-input" placeholder="Search notes..." id="search-notes">
                    </div>
                </div>
                <div class="notes-list">
                    <div class="notes-list-header">
                        <h2 class="section-title">Your Notes</h2>
                        <span class="notes-count" id="notes-count">0</span>
                    </div>
                    <div id="notes-list">
                        <!-- Notes will be populated here -->
                    </div>
                </div>
            </aside>

            <!-- Editor -->
            <div class="editor-container">
                <div class="editor-header">
                    <div class="editor-title-container">
                        <textarea class="editor-title" id="note-title" placeholder="Untitled Note" rows="1"></textarea>
                    </div>
                    <div class="editor-actions">
                        <button class="btn btn-icon" id="image-upload-btn">
                            <span class="material-icons-round">image</span>
                        </button>
                        <button class="btn btn-icon" id="link-insert-btn">
                            <span class="material-icons-round">link</span>
                        </button>
                        <button class="btn btn-icon" id="delete-note-btn">
                            <span class="material-icons-round">delete</span>
                        </button>
                        <div style="position: relative;">
                            <button class="btn btn-icon" id="more-actions-btn">
                                <span class="material-icons-round">more_vert</span>
                            </button>
                            <div class="more-actions-menu" id="more-actions-menu">
                                <button class="menu-item" id="export-note-btn">
                                    <span class="material-icons-round">download</span>
                                    <span>Export Note</span>
                                </button>
                                <button class="menu-item" id="duplicate-note-btn">
                                    <span class="material-icons-round">content_copy</span>
                                    <span>Duplicate Note</span>
                                </button>
                                <button class="menu-item" id="word-count-btn">
                                    <span class="material-icons-round">text_fields</span>
                                    <span>Word Count</span>
                                </button>
                                <div class="menu-divider"></div>
                                <button class="menu-item" id="add-to-favorites-btn">
                                    <span class="material-icons-round">star_border</span>
                                    <span>Add to Favorites</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="editor-tags">
                    <div id="tags-container">
                        <!-- Tags will be populated here -->
                    </div>
                    <input type="text" class="tag-editor" id="new-tag-input" placeholder="Add tag...">
                </div>
                <div class="editor-toolbar">
                    <button class="format-btn" data-format="bold">
                        <span class="material-icons-round">format_bold</span>
                    </button>
                    <button class="format-btn" data-format="italic">
                        <span class="material-icons-round">format_italic</span>
                    </button>
                    <div style="position: relative;">
                        <button class="format-btn" data-format="underline">
                            <span class="material-icons-round">format_underlined</span>
                        </button>
                        <div class="more-actions-menu" id="underline-menu">
                            <button class="menu-item" data-underline-type="underline-straight">
                                <span>Straight</span>
                            </button>
                            <button class="menu-item" data-underline-type="underline-wavy">
                                <span>Wavy</span>
                            </button>
                            <button class="menu-item" data-underline-type="underline-dotted">
                                <span>Dotted</span>
                            </button>
                            <button class="menu-item" data-underline-type="underline-double">
                                <span>Double</span>
                            </button>
                        </div>
                    </div>
                    <button class="format-btn" data-format="bulletList">
                        <span class="material-icons-round">format_list_bulleted</span>
                    </button>
                    <button class="format-btn" data-format="numberedList">
                        <span class="material-icons-round">format_list_numbered</span>
                    </button>
                </div>
                <div class="editor-content">
                    <div class="note-editor" id="note-editor" contenteditable="true" placeholder="Start writing your note here..."></div>
                </div>
            </div>
        </div>

        <!-- AI Assistant FAB -->
        <div class="ai-assistant">
            <button class="ai-fab" id="ai-assistant-btn">
                <span class="material-icons-round">auto_awesome</span>
            </button>
        </div>

        <!-- Overlay for mobile sidebar -->
        <div class="overlay"></div>
    </div>

    <!-- AI Modal -->
    <div class="modal-overlay" id="ai-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="material-icons-round">auto_awesome</span>
                    AI Assistant
                </h2>
                <button class="btn btn-icon" id="close-ai-modal">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <p style="color: var(--md-on-surface-variant);">Enhance your notes with AI-powered features</p>
                
                <div class="ai-features-grid">
                    <div class="ai-feature-card" data-feature="summarize_note">
                        <div class="ai-feature-icon">
                            <span class="material-icons-round">summarize</span>
                        </div>
                        <h3 class="ai-feature-title">Summarize</h3>
                        <p class="ai-feature-description">Create a concise summary of your note</p>
                    </div>
                    
                    <div class="ai-feature-card" data-feature="action_items">
                        <div class="ai-feature-icon">
                            <span class="material-icons-round">checklist</span>
                        </div>
                        <h3 class="ai-feature-title">Action Items</h3>
                        <p class="ai-feature-description">Extract actionable tasks</p>
                    </div>
                    
                    <div class="ai-feature-card" data-feature="continue_writing">
                        <div class="ai-feature-icon">
                            <span class="material-icons-round">edit_note</span>
                        </div>
                        <h3 class="ai-feature-title">Continue Writing</h3>
                        <p class="ai-feature-description">Expand on your ideas</p>
                    </div>
                    
                    <div class="ai-feature-card" data-feature="brainstorm">
                        <div class="ai-feature-icon">
                            <span class="material-icons-round">lightbulb</span>
                        </div>
                        <h3 class="ai-feature-title">Brainstorm</h3>
                        <p class="ai-feature-description">Generate related ideas</p>
                    </div>
                    
                    <div class="ai-feature-card" data-feature="explain">
                        <div class="ai-feature-icon">
                            <span class="material-icons-round">psychology</span>
                        </div>
                        <h3 class="ai-feature-title">Explain</h3>
                        <p class="ai-feature-description">Get detailed explanations</p>
                    </div>
                    
                    <div class="ai-feature-card" data-feature="translate">
                        <div class="ai-feature-icon">
                            <span class="material-icons-round">translate</span>
                        </div>
                        <h3 class="ai-feature-title">Translate</h3>
                        <p class="ai-feature-description">Translate to other languages</p>
                    </div>
                    
                    <div class="ai-feature-card ai-image-feature" data-feature="analyze_images">
                        <div class="ai-feature-icon">
                            <span class="material-icons-round">image_search</span>
                        </div>
                        <h3 class="ai-feature-title">Analyze Images</h3>
                        <p class="ai-feature-description">Get descriptions and insights from images in your note</p>
                    </div>
                </div>
                
                <div class="ai-response" id="ai-response">
                    <div id="ai-response-text" class="ai-response-text">Your AI response will appear here...</div>
                    <div id="ai-loading" class="hidden" style="display: flex; align-items: center; gap: var(--md-spacing-sm);">
                        <div class="loader"></div>
                        <span>Generating response...</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: var(--md-spacing-sm);">
                    <input type="text" id="ai-custom-prompt" placeholder="Or ask a custom question..." style="flex: 1; padding: var(--md-spacing-sm) var(--md-spacing-md); border-radius: var(--md-radius-medium); border: 1px solid var(--md-outline-variant); background: var(--md-surface); color: var(--md-on-surface);">
                    <button class="btn btn-filled" id="send-custom-prompt">
                        <span class="material-icons-round">send</span>
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-text" id="cancel-ai">Cancel</button>
                <button class="btn btn-filled" id="apply-ai-suggestion">Apply to Note</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="export-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Export Note</h2>
                <button class="btn btn-icon" id="close-export-modal">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Choose export format:</p>
                <div class="export-options">
                    <button class="btn btn-outlined export-btn" data-format="txt">
                        <span class="material-icons-round">description</span>
                        <span>TXT</span>
                    </button>
                    <button class="btn btn-outlined export-btn" data-format="pdf">
                        <span class="material-icons-round">picture_as_pdf</span>
                        <span>PDF</span>
                    </button>
                    <button class="btn btn-outlined export-btn" data-format="html">
                        <span class="material-icons-round">code</span>
                        <span>HTML</span>
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-text" id="cancel-export">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Image Upload Modal -->
    <div class="modal-overlay" id="image-upload-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="material-icons-round">image</span>
                    Add Images to Note
                </h2>
                <button class="btn btn-icon" id="close-image-modal">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="image-upload-container">
                    <div class="image-upload-area" id="image-drop-area">
                        <div class="image-upload-icon">
                            <span class="material-icons-round">cloud_upload</span>
                        </div>
                        <h3 class="image-upload-text">Drag & Drop Images Here</h3>
                        <p class="image-upload-hint">or click to browse files</p>
                        <input type="file" id="image-file-input" accept="image/*" multiple style="display: none;">
                        <button class="btn btn-filled image-upload-btn" id="browse-images-btn">
                            <span class="material-icons-round">folder_open</span>
                            <span>Browse Files</span>
                        </button>
                    </div>
                    
                    <div class="uploaded-images" id="uploaded-images-container">
                        <!-- Uploaded images will appear here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-text" id="cancel-image-upload">Cancel</button>
                <button class="btn btn-filled" id="insert-images-btn">Insert Selected Images</button>
            </div>
        </div>
    </div>

    <!-- Link Insert Modal -->
    <div class="modal-overlay" id="link-insert-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="material-icons-round">link</span>
                    Add Link to Note
                </h2>
                <button class="btn btn-icon" id="close-link-modal">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="link-input-container">
                    <input type="url" class="link-input" id="link-url-input" placeholder="Paste URL here...">
                    <input type="text" class="link-input" id="link-text-input" placeholder="Link text (optional)">
                    
                    <div class="link-preview" id="link-preview">
                        <div class="link-preview-title">Preview</div>
                        <div class="link-preview-url" id="link-preview-url">Link will appear here</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-text" id="cancel-link-insert">Cancel</button>
                <button class="btn btn-filled" id="insert-link-btn">Insert Link</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="delete-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Delete Note </h2>
                <button class="btn btn-icon" id="close-delete-modal">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this note? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-text" id="cancel-delete">Cancel</button>
                <button class="btn btn-filled btn-danger" id="confirm-delete">Delete</button>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div class="modal-overlay" id="image-preview-modal">
        <div class="modal-content image-modal">
            <div class="modal-header">
                <h2 class="modal-title">Image Preview</h2>
                <button class="btn btn-icon" id="close-image-preview">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <img id="previewed-image" src="" alt="Preview">
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <span class="material-icons-round" id="notification-icon">info</span>
        <span id="notification-text"></span>
    </div>

    <script>
        // Initialize the app after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Hide splash screen and show main app after 2 seconds
            setTimeout(() => {
                document.getElementById('splash-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('splash-screen').style.display = 'none';
                    document.getElementById('main-app').style.display = 'flex';
                    initializeApp();
                }, 500);
            }, 2000);
        });

        function initializeApp() {
            // State Management
            let notes = [];
            let currentNoteId = null;
            let isDarkTheme = false;
            let isSidebarCollapsed = false;
            let currentUnderlineType = 'underline-straight';
            let uploadedImages = [];

            // DOM Elements
            const themeToggleBtn = document.getElementById('theme-toggle');
            const menuToggleBtn = document.querySelector('.menu-toggle');
            const sidebar = document.querySelector('.sidebar');
            const sidebarResizeHandle = document.querySelector('.sidebar-resize-handle');
            const overlay = document.querySelector('.overlay');
            const newNoteBtn = document.getElementById('new-note-btn');
            const deleteNoteBtn = document.getElementById('delete-note-btn');
            const noteTitleEl = document.getElementById('note-title');
            const noteEditorEl = document.getElementById('note-editor');
            const tagsContainerEl = document.getElementById('tags-container');
            const newTagInput = document.getElementById('new-tag-input');
            const searchInput = document.getElementById('search-notes');
            const notesListEl = document.getElementById('notes-list');
            const notesCountEl = document.getElementById('notes-count');
            const aiAssistantBtn = document.getElementById('ai-assistant-btn');
            const aiModal = document.getElementById('ai-modal');
            const closeAiModalBtn = document.getElementById('close-ai-modal');
            const aiFeatureCards = document.querySelectorAll('.ai-feature-card');
            const aiResponseText = document.getElementById('ai-response-text');
            const aiLoadingIndicator = document.getElementById('ai-loading');
            const aiCustomPrompt = document.getElementById('ai-custom-prompt');
            const sendCustomPromptBtn = document.getElementById('send-custom-prompt');
            const applyAiSuggestionBtn = document.getElementById('apply-ai-suggestion');
            const cancelAiBtn = document.getElementById('cancel-ai');
            const exportModal = document.getElementById('export-modal');
            const closeExportModalBtn = document.getElementById('close-export-modal');
            const cancelExportBtn = document.getElementById('cancel-export');
            const exportFormatBtns = document.querySelectorAll('.export-btn');
            const notification = document.getElementById('notification');
            const notificationIcon = document.getElementById('notification-icon');
            const notificationText = document.getElementById('notification-text');
            const formatBtns = document.querySelectorAll('.format-btn');
            const moreActionsBtn = document.getElementById('more-actions-btn');
            const moreActionsMenu = document.getElementById('more-actions-menu');
            const exportNoteBtn = document.getElementById('export-note-btn');
            const duplicateNoteBtn = document.getElementById('duplicate-note-btn');
            const wordCountBtn = document.getElementById('word-count-btn');
            const addToFavoritesBtn = document.getElementById('add-to-favorites-btn');
            const underlineBtn = document.querySelector('[data-format="underline"]');
            const underlineMenu = document.getElementById('underline-menu');
            const imageUploadBtn = document.getElementById('image-upload-btn');
            const imageUploadModal = document.getElementById('image-upload-modal');
            const closeImageModalBtn = document.getElementById('close-image-modal');
            const imageDropArea = document.getElementById('image-drop-area');
            const imageFileInput = document.getElementById('image-file-input');
            const browseImagesBtn = document.getElementById('browse-images-btn');
            const uploadedImagesContainer = document.getElementById('uploaded-images-container');
            const cancelImageUploadBtn = document.getElementById('cancel-image-upload');
            const insertImagesBtn = document.getElementById('insert-images-btn');
            const imagePreviewModal = document.getElementById('image-preview-modal');
            const closeImagePreviewBtn = document.getElementById('close-image-preview');
            const previewedImage = document.getElementById('previewed-image');
            const linkInsertBtn = document.getElementById('link-insert-btn');
            const linkInsertModal = document.getElementById('link-insert-modal');
            const closeLinkModalBtn = document.getElementById('close-link-modal');
            const linkUrlInput = document.getElementById('link-url-input');
            const linkTextInput = document.getElementById('link-text-input');
            const linkPreviewUrl = document.getElementById('link-preview-url');
            const cancelLinkInsertBtn = document.getElementById('cancel-link-insert');
            const insertLinkBtn = document.getElementById('insert-link-btn');
            const deleteModal = document.getElementById('delete-modal');
            const closeDeleteModalBtn = document.getElementById('close-delete-modal');
            const cancelDeleteBtn = document.getElementById('cancel-delete');
            const confirmDeleteBtn = document.getElementById('confirm-delete');

            // API Key
            const GEMINI_API_KEY = "AIzaSyB99Bow78KTvGN3GZkn0hs3-RMonLweLv0";

            // Show notification
            function showNotification(message, type = 'info') {
                notificationText.textContent = message;
                
                // Set icon based on type
                let iconName = 'info';
                if (type === 'success') iconName = 'check_circle';
                if (type === 'error') iconName = 'error';
                
                notificationIcon.textContent = iconName;
                notification.classList.add('show');
                
                // Auto hide after 3 seconds
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }

            // Theme Toggle
            themeToggleBtn.addEventListener('click', () => {
                isDarkTheme = !isDarkTheme;
                document.body.classList.toggle('dark-theme', isDarkTheme);
                document.body.classList.toggle('light-theme', !isDarkTheme);
                
                const icon = themeToggleBtn.querySelector('.material-icons-round');
                icon.textContent = isDarkTheme ? 'light_mode' : 'dark_mode';
                
                showNotification(`Switched to ${isDarkTheme ? 'dark' : 'light'} theme`);
                
                // Save theme preference
                localStorage.setItem('mindscribe-theme', isDarkTheme ? 'dark' : 'light');
            });

            // Load theme preference
            const savedTheme = localStorage.getItem('mindscribe-theme');
            if (savedTheme === 'dark') {
                isDarkTheme = true;
                document.body.classList.add('dark-theme');
                document.body.classList.remove('light-theme');
                themeToggleBtn.querySelector('.material-icons-round').textContent = 'light_mode';
            }

            // Mobile Menu Toggle
            menuToggleBtn.addEventListener('click', () => {
                sidebar.classList.add('active');
                overlay.classList.add('active');
            });

            overlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                moreActionsMenu.classList.remove('active');
                underlineMenu.classList.remove('active');
            });

            // Sidebar Resize Functionality
            let isResizing = false;
            sidebarResizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                const newWidth = e.clientX;
                if (newWidth > 200 && newWidth < 500) {
                    sidebar.style.width = `${newWidth}px`;
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = '';
                }
            });

            // Toggle sidebar collapse
            sidebarResizeHandle.addEventListener('dblclick', () => {
                isSidebarCollapsed = !isSidebarCollapsed;
                sidebar.classList.toggle('collapsed', isSidebarCollapsed);
                
                if (isSidebarCollapsed) {
                    sidebar.style.width = '60px';
                } else {
                    sidebar.style.width = '320px';
                }
                
                showNotification(`Sidebar ${isSidebarCollapsed ? 'collapsed' : 'expanded'}`);
            });

            // Three dots menu functionality
            moreActionsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                moreActionsMenu.classList.toggle('active');
            });

            // Export from three dots menu
            exportNoteBtn.addEventListener('click', () => {
                exportModal.classList.add('active');
                moreActionsMenu.classList.remove('active');
            });

            // Underline menu functionality
            underlineBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                underlineMenu.classList.toggle('active');
            });

            // Close menu when clicking outside
            document.addEventListener('click', () => {
                moreActionsMenu.classList.remove('active');
                underlineMenu.classList.remove('active');
            });

            // Prevent menu from closing when clicking inside
            moreActionsMenu.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            underlineMenu.addEventListener('click', (e) => {
                e.stopPropagation();
                if (e.target.dataset.underlineType) {
                    currentUnderlineType = e.target.dataset.underlineType;
                    underlineMenu.classList.remove('active');
                    showNotification(`Underline style changed to ${e.target.textContent}`);
                }
            });

            // Duplicate note functionality
            duplicateNoteBtn.addEventListener('click', () => {
                if (!currentNoteId) {
                    showNotification('No note selected', 'error');
                    return;
                }
                
                const originalNote = notes.find(n => n.id === currentNoteId);
                if (originalNote) {
                    const duplicatedNote = {
                        id: Date.now().toString(),
                        title: `${originalNote.title} (Copy)`,
                        content: originalNote.content,
                        tags: [...originalNote.tags],
                        createdAt: Date.now(),
                        updatedAt: Date.now()
                    };
                    
                    notes.unshift(duplicatedNote);
                    saveNotes();
                    renderNotesList(notes);
                    selectNote(duplicatedNote.id);
                    
                    showNotification('Note duplicated successfully');
                }
                
                moreActionsMenu.classList.remove('active');
            });

            // Word count functionality
            wordCountBtn.addEventListener('click', () => {
                if (!currentNoteId) {
                    showNotification('No note selected', 'error');
                    return;
                }
                
                const note = notes.find(n => n.id === currentNoteId);
                if (note) {
                    const wordCount = note.content.split(/\s+/).filter(word => word.length > 0).length;
                    const charCount = note.content.length;
                    
                    showNotification(`Word count: ${wordCount} words, ${charCount} characters`);
                }
                
                moreActionsMenu.classList.remove('active');
            });

            // Add to favorites functionality
            addToFavoritesBtn.addEventListener('click', () => {
                if (!currentNoteId) {
                    showNotification('No note selected', 'error');
                    return;
                }
                
                const noteIndex = notes.findIndex(n => n.id === currentNoteId);
                if (noteIndex > -1) {
                    // Toggle favorite status
                    notes[noteIndex].isFavorite = !notes[noteIndex].isFavorite;
                    saveNotes();
                    
                    const status = notes[noteIndex].isFavorite ? 'added to' : 'removed from';
                    showNotification(`Note ${status} favorites`);
                }
                
                moreActionsMenu.classList.remove('active');
            });

            // Load notes from localStorage
            function loadNotes() {
                try {
                    const storedNotes = localStorage.getItem('mindscribe-notes');
                    notes = storedNotes ? JSON.parse(storedNotes) : [];
                    
                    // Create welcome note if no notes exist
                    if (notes.length === 0) {
                        const welcomeNote = {
                            id: Date.now().toString(),
                            title: 'Welcome to Mindscribe!',
                            content: 'This is your first note. You can edit this text, add tags, and use the AI assistant to enhance your notes.\n\nClick the AI button in the bottom right to see what the AI can do for you!',
                            tags: ['Welcome', 'Getting Started'],
                            createdAt: Date.now(),
                            updatedAt: Date.now()
                        };
                        notes.push(welcomeNote);
                        saveNotes();
                    }
                } catch (error) {
                    console.error("Failed to load notes from local storage:", error);
                    notes = [];
                }
                
                renderNotesList(notes);
                updateNotesCount();
                
                // Select the first note by default
                if (notes.length > 0) {
                    selectNote(notes[0].id);
                }
            }

            // Save notes to localStorage
            function saveNotes() {
                try {
                    localStorage.setItem('mindscribe-notes', JSON.stringify(notes));
                } catch (error) {
                    console.error("Failed to save notes to local storage:", error);
                    showNotification('Failed to save notes', 'error');
                }
            }

            // Render notes list
            function renderNotesList(notesToRender) {
                notesListEl.innerHTML = '';
                
                // Sort notes by updatedAt (newest first)
                notesToRender.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
                
                notesToRender.forEach(note => {
                    const noteEl = document.createElement('div');
                    noteEl.className = 'note-item';
                    noteEl.dataset.id = note.id;
                    
                    // Check if note has images
                    const hasImages = note.content && note.content.includes('<img');
                    // Check if note has links
                    const hasLinks = note.content && (note.content.includes('href=') || note.content.includes('youtube.com/embed'));
                    
                    noteEl.innerHTML = `
                        <div class="note-title">${note.title || 'Untitled'}</div>
                        <div class="note-preview">${note.content ? note.content.substring(0, 100).replace(/<[^>]*>/g, '') + (note.content.length > 100 ? '...' : '') : '...'}</div>
                        <div class="note-meta">
                            <div class="note-tags">
                                ${note.tags && note.tags.length > 0 ? 
                                    note.tags.slice(0, 2).map(tag => `<span class="tag">${tag}</span>`).join('') : 
                                    ''}
                                ${note.tags && note.tags.length > 2 ? `<span class="tag">+${note.tags.length - 2}</span>` : ''}
                                ${hasImages ? '<span class="tag"><span class="material-icons-round" style="font-size: 12px;">image</span></span>' : ''}
                                ${hasLinks ? '<span class="tag"><span class="material-icons-round" style="font-size: 12px;">link</span></span>' : ''}
                            </div>
                            <div class="note-date">${formatDate(note.updatedAt)}</div>
                        </div>
                    `;
                    
                    noteEl.addEventListener('click', () => {
                        selectNote(note.id);
                        // Close sidebar on mobile after selection
                        if (window.innerWidth <= 768) {
                            sidebar.classList.remove('active');
                            overlay.classList.remove('active');
                        }
                    });
                    
                    notesListEl.appendChild(noteEl);
                });
                
                // Highlight selected note
                if (currentNoteId) {
                    const selectedNote = document.querySelector(`.note-item[data-id="${currentNoteId}"]`);
                    if (selectedNote) {
                        selectedNote.classList.add('selected');
                    }
                }
            }

            // Update notes count
            function updateNotesCount() {
                notesCountEl.textContent = notes.length;
            }

            // Select a note
            function selectNote(noteId) {
                currentNoteId = noteId;
                const note = notes.find(n => n.id === noteId);
                
                if (note) {
                    noteTitleEl.value = note.title || '';
                    noteEditorEl.innerHTML = note.content || '';
                    renderTags(note.tags || []);
                    
                    // Add click handlers for images and links in the editor
                    addImageClickHandlers();
                    addLinkClickHandlers();
                    
                    // Remove selected class from all notes
                    document.querySelectorAll('.note-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    // Add selected class to the clicked note
                    const selectedNote = document.querySelector(`.note-item[data-id="${noteId}"]`);
                    if (selectedNote) {
                        selectedNote.classList.add('selected');
                    }
                }
            }

            // Render tags
            function renderTags(tags) {
                tagsContainerEl.innerHTML = '';
                
                if (tags && tags.length > 0) {
                    tags.forEach(tag => {
                        const tagEl = document.createElement('span');
                        tagEl.className = 'tag';
                        tagEl.textContent = tag;
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'tag-remove';
                        removeBtn.innerHTML = '<span class="material-icons-round" style="font-size: 14px;">close</span>';
                        removeBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            removeTag(tag);
                        });
                        
                        tagEl.appendChild(removeBtn);
                        tagsContainerEl.appendChild(tagEl);
                    });
                }
            }

            // Remove tag
            function removeTag(tagToRemove) {
                const noteIndex = notes.findIndex(n => n.id === currentNoteId);
                if (noteIndex > -1) {
                    notes[noteIndex].tags = notes[noteIndex].tags.filter(tag => tag !== tagToRemove);
                    saveNotes();
                    renderTags(notes[noteIndex].tags);
                    showNotification(`Removed tag: ${tagToRemove}`);
                }
            }

            // Format date - FIXED VERSION
            function formatDate(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                
                // Reset time part for date comparison
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const noteDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                
                const diffTime = today.getTime() - noteDate.getTime();
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) return 'Today';
                if (diffDays === 1) return 'Yesterday';
                if (diffDays <= 7) return `${diffDays} days ago`;
                
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }

            // Save note changes with debounce
            let saveTimeout;
            function saveNoteChanges() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    const noteIndex = notes.findIndex(n => n.id === currentNoteId);
                    if (noteIndex > -1) {
                        // Get tags from the tags container
                        const updatedTags = Array.from(tagsContainerEl.querySelectorAll('.tag'))
                            .map(el => {
                                const text = el.textContent;
                                return text.replace('close', '').trim();
                            });
                        
                        notes[noteIndex].title = noteTitleEl.value;
                        notes[noteIndex].content = noteEditorEl.innerHTML;
                        notes[noteIndex].tags = updatedTags;
                        notes[noteIndex].updatedAt = Date.now();
                        
                        saveNotes();
                        renderNotesList(notes);
                    }
                }, 500);
            }

            // Create new note
            function createNewNote() {
                const newNote = {
                    id: Date.now().toString(),
                    title: 'New Note',
                    content: '',
                    tags: [],
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
                
                notes.unshift(newNote);
                saveNotes();
                renderNotesList(notes);
                selectNote(newNote.id);
                
                // Focus on title field
                setTimeout(() => {
                    noteTitleEl.focus();
                }, 100);
                
                showNotification('Created a new note');
            }

            // Delete current note
            function deleteCurrentNote() {
                if (!currentNoteId) return;
                
                const noteIndex = notes.findIndex(n => n.id === currentNoteId);
                if (noteIndex > -1) {
                    const noteTitle = notes[noteIndex].title || 'Untitled';
                    notes.splice(noteIndex, 1);
                    saveNotes();
                    renderNotesList(notes);
                    updateNotesCount();
                    
                    // Select another note if available
                    if (notes.length > 0) {
                        selectNote(notes[0].id);
                    } else {
                        // Clear editor if no notes left
                        currentNoteId = null;
                        noteTitleEl.value = '';
                        noteEditorEl.innerHTML = '';
                        renderTags([]);
                    }
                    
                    showNotification(`Deleted note: ${noteTitle}`);
                }
            }

            // Search notes
            function searchNotes(searchTerm) {
                if (!searchTerm) {
                    renderNotesList(notes);
                    return;
                }
                
                const filteredNotes = notes.filter(note => 
                    (note.title && note.title.toLowerCase().includes(searchTerm)) ||
                    (note.content && note.content.toLowerCase().includes(searchTerm)) ||
                    (note.tags && note.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
                );
                
                renderNotesList(filteredNotes);
            }

            // Add new tag
            function addNewTag() {
                if (!currentNoteId) return;
                
                const tagText = newTagInput.value.trim();
                if (tagText) {
                    const noteIndex = notes.findIndex(n => n.id === currentNoteId);
                    if (noteIndex > -1) {
                        if (!notes[noteIndex].tags) notes[noteIndex].tags = [];
                        
                        if (!notes[noteIndex].tags.includes(tagText)) {
                            notes[noteIndex].tags.push(tagText);
                            saveNotes();
                            renderTags(notes[noteIndex].tags);
                            newTagInput.value = '';
                            showNotification(`Added tag: ${tagText}`);
                        } else {
                            showNotification('Tag already exists', 'error');
                        }
                    }
                }
            }

            // Text formatting functions
            function formatText(command, value = null) {
                document.execCommand(command, false, value);
                noteEditorEl.focus();
            }

            // Image Upload Functionality - FIXED VERSION
            imageUploadBtn.addEventListener('click', () => {
                imageUploadModal.classList.add('active');
            });

            closeImageModalBtn.addEventListener('click', () => {
                imageUploadModal.classList.remove('active');
                clearUploadedImages();
            });

            cancelImageUploadBtn.addEventListener('click', () => {
                imageUploadModal.classList.remove('active');
                clearUploadedImages();
            });

            // Browse images button
            browseImagesBtn.addEventListener('click', () => {
                imageFileInput.click();
            });

            // Handle file selection
            imageFileInput.addEventListener('change', (e) => {
                handleImageFiles(e.target.files);
            });

            // Drag and drop functionality
            imageDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                imageDropArea.classList.add('drag-over');
            });

            imageDropArea.addEventListener('dragleave', () => {
                imageDropArea.classList.remove('drag-over');
            });

            imageDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                imageDropArea.classList.remove('drag-over');
                handleImageFiles(e.dataTransfer.files);
            });

            // Click to upload
            imageDropArea.addEventListener('click', () => {
                imageFileInput.click();
            });

            // Handle image files
            function handleImageFiles(files) {
                if (!files || files.length === 0) return;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // Check if file is an image
                    if (!file.type.match('image.*')) {
                        showNotification('Please upload only image files', 'error');
                        continue;
                    }
                    
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        const imageData = {
                            id: Date.now().toString() + i,
                            name: file.name,
                            dataUrl: e.target.result,
                            selected: true
                        };
                        
                        uploadedImages.push(imageData);
                        renderUploadedImages();
                    };
                    
                    reader.readAsDataURL(file);
                }
            }

            // Render uploaded images
            function renderUploadedImages() {
                uploadedImagesContainer.innerHTML = '';
                
                if (uploadedImages.length === 0) {
                    uploadedImagesContainer.innerHTML = '<p style="color: var(--md-on-surface-variant); text-align: center; grid-column: 1 / -1;">No images uploaded yet</p>';
                    return;
                }
                
                uploadedImages.forEach(image => {
                    const imageEl = document.createElement('div');
                    imageEl.className = 'uploaded-image';
                    imageEl.innerHTML = `
                        <img src="${image.dataUrl}" alt="${image.name}">
                        <div class="image-actions">
                            <button class="image-action-btn preview-image" data-id="${image.id}">
                                <span class="material-icons-round">visibility</span>
                            </button>
                            <button class="image-action-btn remove-image" data-id="${image.id}">
                                <span class="material-icons-round">delete</span>
                            </button>
                        </div>
                    `;
                    
                    uploadedImagesContainer.appendChild(imageEl);
                });
                
                // Add event listeners for image actions
                document.querySelectorAll('.preview-image').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const imageId = btn.dataset.id;
                        const image = uploadedImages.find(img => img.id === imageId);
                        if (image) {
                            previewImage(image.dataUrl);
                        }
                    });
                });
                
                document.querySelectorAll('.remove-image').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const imageId = btn.dataset.id;
                        uploadedImages = uploadedImages.filter(img => img.id !== imageId);
                        renderUploadedImages();
                    });
                });
            }

            // Clear uploaded images
            function clearUploadedImages() {
                uploadedImages = [];
                renderUploadedImages();
            }

            // Preview image in modal
            function previewImage(dataUrl) {
                previewedImage.src = dataUrl;
                imagePreviewModal.classList.add('active');
            }

            closeImagePreviewBtn.addEventListener('click', () => {
                imagePreviewModal.classList.remove('active');
            });

            // Insert images into note - COMPLETELY FIXED VERSION
            insertImagesBtn.addEventListener('click', () => {
                if (uploadedImages.length === 0) {
                    showNotification('No images to insert', 'error');
                    return;
                }
                
                // Ensure we have a note selected
                if (!currentNoteId) {
                    showNotification('Please create or select a note first', 'error');
                    return;
                }
                
                // Focus on editor to ensure we can insert content
                noteEditorEl.focus();
                
                uploadedImages.forEach(image => {
                    // Create image element
                    const imgElement = document.createElement('img');
                    imgElement.src = image.dataUrl;
                    imgElement.alt = image.name;
                    imgElement.className = 'editor-image';
                    imgElement.style.maxWidth = '100%';
                    imgElement.style.height = 'auto';
                    imgElement.style.display = 'block';
                    imgElement.style.margin = '10px 0';
                    
                    // Add click handler for the new image
                    imgElement.addEventListener('click', () => {
                        previewImage(image.dataUrl);
                    });
                    
                    // Insert at cursor position or at the end
                    const selection = window.getSelection();
                    if (selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        range.insertNode(imgElement);
                        
                        // Add a line break after the image
                        const br = document.createElement('br');
                        range.insertNode(br);
                        
                        // Set cursor after the image
                        range.setStartAfter(br);
                        range.collapse(true);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    } else {
                        // If no selection, append to the end
                        noteEditorEl.appendChild(imgElement);
                        noteEditorEl.appendChild(document.createElement('br'));
                    }
                });
                
                // Save the note with images
                saveNoteChanges();
                
                // Close the modal and clear uploaded images
                imageUploadModal.classList.remove('active');
                clearUploadedImages();
                
                showNotification(`Inserted ${uploadedImages.length} image(s) into note`);
            });

            // Add click handlers for images in the editor
            function addImageClickHandlers() {
                const images = noteEditorEl.querySelectorAll('img');
                images.forEach(img => {
                    // Remove existing handlers to avoid duplicates
                    img.removeEventListener('click', handleImageClick);
                    // Add new handler
                    img.addEventListener('click', handleImageClick);
                });
            }
            
            function handleImageClick(e) {
                previewImage(e.target.src);
            }

            // Link Insert Functionality - FIXED VERSION
            linkInsertBtn.addEventListener('click', () => {
                linkInsertModal.classList.add('active');
                linkUrlInput.focus();
            });

            closeLinkModalBtn.addEventListener('click', () => {
                linkInsertModal.classList.remove('active');
                clearLinkInputs();
            });

            cancelLinkInsertBtn.addEventListener('click', () => {
                linkInsertModal.classList.remove('active');
                clearLinkInputs();
            });

            // Update link preview
            linkUrlInput.addEventListener('input', () => {
                const url = linkUrlInput.value.trim();
                if (url) {
                    linkPreviewUrl.textContent = url;
                } else {
                    linkPreviewUrl.textContent = 'Link will appear here';
                }
            });

            // Insert link into note - COMPLETELY FIXED VERSION
            insertLinkBtn.addEventListener('click', () => {
                const url = linkUrlInput.value.trim();
                const text = linkTextInput.value.trim() || url;
                
                if (!url) {
                    showNotification('Please enter a URL', 'error');
                    return;
                }
                
                // Validate URL
                try {
                    new URL(url);
                } catch (e) {
                    showNotification('Please enter a valid URL', 'error');
                    return;
                }
                
                // Ensure we have a note selected
                if (!currentNoteId) {
                    showNotification('Please create or select a note first', 'error');
                    return;
                }
                
                // Focus on editor
                noteEditorEl.focus();
                
                let linkElement;
                
                // Check if it's a YouTube URL
                if (isYouTubeUrl(url)) {
                    const videoId = getYouTubeVideoId(url);
                    if (videoId) {
                        // Create YouTube embed
                        linkElement = document.createElement('div');
                        linkElement.innerHTML = `
                            <iframe 
                                src="https://www.youtube.com/embed/${videoId}" 
                                class="youtube-embed"
                                frameborder="0" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen>
                            </iframe>
                            <br>
                        `;
                    } else {
                        // Create regular link for invalid YouTube URL
                        linkElement = document.createElement('a');
                        linkElement.href = url;
                        linkElement.textContent = text;
                        linkElement.className = 'editor-link';
                        linkElement.target = '_blank';
                    }
                } else {
                    // Create regular link
                    linkElement = document.createElement('a');
                    linkElement.href = url;
                    linkElement.textContent = text;
                    linkElement.className = 'editor-link';
                    linkElement.target = '_blank';
                }
                
                // Insert at cursor position or at the end
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    range.insertNode(linkElement);
                    
                    // Add a space after the link
                    const space = document.createTextNode(' ');
                    range.insertNode(space);
                    
                    // Set cursor after the link
                    range.setStartAfter(space);
                    range.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(range);
                } else {
                    // If no selection, append to the end
                    noteEditorEl.appendChild(linkElement);
                    noteEditorEl.appendChild(document.createTextNode(' '));
                }
                
                // Save the note with link
                saveNoteChanges();
                
                // Close the modal and clear inputs
                linkInsertModal.classList.remove('active');
                clearLinkInputs();
                
                showNotification('Link inserted into note');
            });

            // Check if URL is a YouTube URL
            function isYouTubeUrl(url) {
                return url.includes('youtube.com') || url.includes('youtu.be');
            }

            // Extract YouTube video ID from URL
            function getYouTubeVideoId(url) {
                const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
                const match = url.match(regExp);
                return (match && match[7].length === 11) ? match[7] : false;
            }

            // Clear link inputs
            function clearLinkInputs() {
                linkUrlInput.value = '';
                linkTextInput.value = '';
                linkPreviewUrl.textContent = 'Link will appear here';
            }

            // Add click handlers for links in the editor
            function addLinkClickHandlers() {
                const links = noteEditorEl.querySelectorAll('a');
                links.forEach(link => {
                    // Remove existing handlers to avoid duplicates
                    link.removeEventListener('click', handleLinkClick);
                    // Add new handler
                    link.addEventListener('click', handleLinkClick);
                });
            }
            
            function handleLinkClick(e) {
                if (e.target.target === '_blank') {
                    e.preventDefault();
                    window.open(e.target.href, '_blank');
                }
            }

            // Delete Confirmation Modal Functionality
            deleteNoteBtn.addEventListener('click', () => {
                if (!currentNoteId) {
                    showNotification('No note selected', 'error');
                    return;
                }
                deleteModal.classList.add('active');
            });

            closeDeleteModalBtn.addEventListener('click', () => {
                deleteModal.classList.remove('active');
            });

            cancelDeleteBtn.addEventListener('click', () => {
                deleteModal.classList.remove('active');
            });

            confirmDeleteBtn.addEventListener('click', () => {
                deleteCurrentNote();
                deleteModal.classList.remove('active');
            });

            // Call Gemini API - FIXED VERSION with image analysis
            async function callGeminiAPI(promptType, customPrompt) {
                const note = notes.find(n => n.id === currentNoteId);
                if (!note) {
                    showNotification('No note selected', 'error');
                    return;
                }
                
                aiResponseText.textContent = 'Generating response...';
                aiLoadingIndicator.classList.remove('hidden');
                
                // Scroll to response area
                const modalBody = document.querySelector('.modal-body');
                modalBody.scrollTo({ top: modalBody.scrollHeight, behavior: 'smooth' });
                
                let fullPrompt = '';
                
                // Extract image data from note content
                const imageDataUrls = [];
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = note.content;
                const images = tempDiv.querySelectorAll('img');
                
                images.forEach(img => {
                    if (img.src.startsWith('data:')) {
                        imageDataUrls.push(img.src);
                    }
                });
                
                // Extract links from note content
                const links = [];
                const linkElements = tempDiv.querySelectorAll('a');
                linkElements.forEach(link => {
                    if (link.href) {
                        links.push({
                            text: link.textContent,
                            url: link.href
                        });
                    }
                });
                
                // Construct the prompt based on the prompt type
                switch (promptType) {
                    case 'summarize_note':
                        fullPrompt = `Summarize the following note into exactly 3 clear bullet points.

NOTE CONTENT:
"${note.content || "No content provided"}"

${links.length > 0 ? `LINKS IN NOTE:\n${links.map(link => `- ${link.text}: ${link.url}`).join('\n')}\n\n` : ''}

Instructions:
1. Use plain text only (no **, *, ##, or Markdown).
2. Format as 3 bullet points with bullet point().
3. Each point should be short and focused.
4. Do not add extra commentary before or after the summary.
5. ${links.length > 0 ? 'Include relevant information from the links in your summary.' : ''}
`;
                        break;
                    case 'action_items':
                        fullPrompt = `Generate a numbered list of action items from the following note.\n\nNOTE CONTENT:\n"${note.content}"\n\n${links.length > 0 ? `LINKS IN NOTE:\n${links.map(link => `- ${link.text}: ${link.url}`).join('\n')}\n\n` : ''}`;
                        break;
                    case 'continue_writing':
                        fullPrompt = `Continue writing from the last sentence of this note. Provide a coherent and natural continuation of the text.\n\nNOTE CONTENT:\n"${note.content}"\n\n${links.length > 0 ? `LINKS IN NOTE:\n${links.map(link => `- ${link.text}: ${link.url}`).join('\n')}\n\n` : ''}`;
                        break;
                    case 'brainstorm':
                        fullPrompt = `Based on the title "${note.title}" and the following note content, provide a short list of 5-7 related ideas or concepts.\n\nNOTE CONTENT:\n"${note.content}"\n\n${links.length > 0 ? `LINKS IN NOTE:\n${links.map(link => `- ${link.text}: ${link.url}`).join('\n')}\n\n` : ''}`;
                        break;
                    case 'explain':
                        fullPrompt = `Explain the concepts in this note in more detail:

NOTE TITLE: "${note.title || 'Untitled'}"
NOTE CONTENT: "${note.content || 'No content'}"
${links.length > 0 ? `LINKS IN NOTE:\n${links.map(link => `- ${link.text}: ${link.url}`).join('\n')}\n\n` : ''}

Please provide a detailed explanation of the key concepts mentioned in this note.`;
                        break;
                    case 'translate':
                        fullPrompt = `Translate the following note to English:

NOTE TITLE: "${note.title || 'Untitled'}"
NOTE CONTENT: "${note.content || 'No content'}"
${links.length > 0 ? `LINKS IN NOTE:\n${links.map(link => `- ${link.text}: ${link.url}`).join('\n')}\n\n` : ''}

Please provide an accurate translation.`;
                        break;
                    case 'analyze_images':
                        if (imageDataUrls.length === 0) {
                            aiResponseText.textContent = "No images found in this note to analyze.";
                            aiLoadingIndicator.classList.add('hidden');
                            return;
                        }
                        
                        fullPrompt = `Analyze the images in this note and provide insights:

NOTE TITLE: "${note.title || 'Untitled'}"
NOTE CONTENT: "${note.content ? note.content.replace(/<img[^>]*>/g, '[IMAGE]') : 'No content'}"
${links.length > 0 ? `LINKS IN NOTE:\n${links.map(link => `- ${link.text}: ${link.url}`).join('\n')}\n\n` : ''}

Please describe what you see in the images and how they relate to the note content.`;
                        break;
                    case 'custom':
                    default:
                        fullPrompt = `You are Mindscribe AI, an assistant that helps with note-taking. 
The user asked: "${customPrompt}"

Context of the note:
- Title: ${note.title || "Untitled"}
- Content: ${note.content || "Empty note"}
${links.length > 0 ? `- Links: ${links.map(link => `${link.text} (${link.url})`).join(', ')}\n` : ''}

Instructions:
1. DO NOT use Markdown symbols like **, *, or ##.
2. Use plain text only.
3. If you need emphasis, use UPPERCASE words or dashes (-) instead.
4. Keep your answer clear and concise.
5. Consider any links in the note when formulating your response.
`;
                        break;
                }
                
                const payload = {
                    contents: [{
                        parts: [{ text: fullPrompt }]
                    }]
                };
                
                // For image analysis, we need to use the vision model
                if (promptType === 'analyze_images' && imageDataUrls.length > 0) {
                    // Use the first image for analysis (you could extend this to handle multiple images)
                    const imageData = imageDataUrls[0];
                    
                    payload.contents[0].parts = [
                        { text: fullPrompt },
                        {
                            inline_data: {
                                mime_type: "image/jpeg",
                                data: imageData.split(',')[1] // Remove the data:image/jpeg;base64, part
                            }
                        }
                    ];
                }
                
                try {
                    // Using the correct Gemini API endpoint
                    const model = promptType === 'analyze_images' ? 'gemini-1.5-flash' : 'gemini-2.5-flash';
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("API Error:", errorData);
                        throw new Error(`API error: ${response.status} ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.candidates && 
                        result.candidates[0] && 
                        result.candidates[0].content && 
                        result.candidates[0].content.parts && 
                        result.candidates[0].content.parts[0] && 
                        result.candidates[0].content.parts[0].text) {
                        
                        aiResponseText.textContent = result.candidates[0].content.parts[0].text;
                        showNotification('AI response generated successfully', 'success');
                    } else {
                        aiResponseText.textContent = "Sorry, I could not generate a response. Please try again.";
                        console.error("Unexpected API response:", result);
                        showNotification('Failed to generate AI response', 'error');
                    }
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    aiResponseText.textContent = "An error occurred. Please try again.";
                    showNotification('Error connecting to AI service.', 'error');
                } finally {
                    aiLoadingIndicator.classList.add('hidden');
                    
                    // Scroll to response area
                    setTimeout(() => {
                        modalBody.scrollTo({ top: modalBody.scrollHeight, behavior: 'smooth' });
                    }, 100);
                }
            }

            // Apply AI suggestion to note
            function applyAiSuggestion() {
                if (!currentNoteId || !aiResponseText.textContent) return;
                
                const noteIndex = notes.findIndex(n => n.id === currentNoteId);
                if (noteIndex > -1) {
                    notes[noteIndex].content += '\n\n---\n\n' + aiResponseText.textContent;
                    notes[noteIndex].updatedAt = Date.now();
                    
                    saveNotes();
                    noteEditorEl.innerHTML = notes[noteIndex].content;
                    
                    // Close AI modal
                    aiModal.classList.remove('active');
                    
                    showNotification('AI suggestion applied to note');
                }
            }

            // Export note
            function exportNote(format) {
                const note = notes.find(n => n.id === currentNoteId);
                if (!note) {
                    showNotification('No note selected', 'error');
                    return;
                }
                
                let content, mimeType, filename;
                
                switch (format) {
                    case 'txt':
                        content = `${note.title}\n\n${note.content.replace(/<[^>]*>/g, '')}`;
                        mimeType = 'text/plain';
                        filename = `${note.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.txt`;
                        break;
                    case 'pdf':
                        // For PDF, we'll create a simple HTML representation and use browser print
                        content = `
                            <html>
                                <head>
                                    <title>${note.title}</title>
                                    <style>
                                        body { font-family: Arial, sans-serif; padding: 20px; }
                                        h1 { color: #333; }
                                        pre { white-space: pre-wrap; font-family: inherit; }
                                    </style>
                                </head>
                                <body>
                                    <h1>${note.title}</h1>
                                    <pre>${note.content.replace(/<[^>]*>/g, '')}</pre>
                                </body>
                            </html>
                        `;
                        const printWindow = window.open('', '_blank');
                        printWindow.document.write(content);
                        printWindow.document.close();
                        printWindow.print();
                        return;
                    case 'html':
                        content = `
                            <!DOCTYPE html>
                            <html>
                                <head>
                                    <title>${note.title}</title>
                                    <meta charset="UTF-8">
                                    <style>
                                        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; }
                                        h1 { color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; }
                                        .content { white-space: pre-wrap; background: #f5f5f5; padding: 15px; border-radius: 5px; }
                                    </style>
                                </head>
                                <body>
                                    <h1>${note.title}</h1>
                                    <div class="content">${note.content}</div>
                                </body>
                            </html>
                        `;
                        mimeType = 'text/html';
                        filename = `${note.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.html`;
                        break;
                }
                
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification(`Exported as ${format.toUpperCase()}`);
                exportModal.classList.remove('active');
            }

            // Event Listeners
            newNoteBtn.addEventListener('click', createNewNote);
            
            noteTitleEl.addEventListener('input', saveNoteChanges);
            noteEditorEl.addEventListener('input', saveNoteChanges);
            
            // Auto-resize title textarea
            noteTitleEl.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            searchInput.addEventListener('input', (e) => {
                searchNotes(e.target.value.toLowerCase());
            });
            
            newTagInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    addNewTag();
                }
            });
            
            // Format buttons
            formatBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const format = btn.dataset.format;
                    
                    switch (format) {
                        case 'bold':
                            formatText('bold');
                            showNotification('Bold formatting applied');
                            break;
                        case 'italic':
                            formatText('italic');
                            showNotification('Italic formatting applied');
                            break;
                        case 'underline':
                            formatText('styleWithCSS');
                            formatText(currentUnderlineType);
                            showNotification('Underline formatting applied');
                            break;
                        case 'bulletList':
                            formatText('insertUnorderedList');
                            showNotification('Bullet list created');
                            break;
                        case 'numberedList':
                            formatText('insertOrderedList');
                            showNotification('Numbered list created');
                            break;
                    }
                });
            });
            
            // AI Modal
            aiAssistantBtn.addEventListener('click', () => {
                aiModal.classList.add('active');
            });
            
            closeAiModalBtn.addEventListener('click', () => {
                aiModal.classList.remove('active');
            });
            
            cancelAiBtn.addEventListener('click', () => {
                aiModal.classList.remove('active');
            });
            
            // AI Feature Cards
            aiFeatureCards.forEach(card => {
                card.addEventListener('click', () => {
                    const feature = card.dataset.feature;
                    callGeminiAPI(feature, '');
                });
            });
            
            // Custom AI Prompt
            sendCustomPromptBtn.addEventListener('click', () => {
                const prompt = aiCustomPrompt.value.trim();
                if (prompt) {
                    callGeminiAPI('custom', prompt);
                    aiCustomPrompt.value = '';
                } else {
                    showNotification('Please enter a question first', 'error');
                }
            });
            
            aiCustomPrompt.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    sendCustomPromptBtn.click();
                }
            });
            
            applyAiSuggestionBtn.addEventListener('click', applyAiSuggestion);
            
            // Export
            closeExportModalBtn.addEventListener('click', () => {
                exportModal.classList.remove('active');
            });
            
            cancelExportBtn.addEventListener('click', () => {
                exportModal.classList.remove('active');
            });
            
            exportFormatBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const format = btn.dataset.format;
                    exportNote(format);
                });
            });
            
            // Initialize the app
            loadNotes();
        }
    </script>
</body>
</html>
